# è§†é¢‘AIåˆ†æåŠŸèƒ½éœ€æ±‚ç›®å½•

> æœ¬ç›®å½•å°†"è§†é¢‘ä¼ è¾“åˆ°Python APIå±‚ + Google AI SDKåˆ†æ"éœ€æ±‚æ‹†åˆ†ä¸ºç‹¬ç«‹çš„å­æ¨¡å—ï¼Œæ¯ä¸ªå­æ¨¡å—å¯ç‹¬ç«‹å¼€å‘ä¸æµ‹è¯•ã€‚

---

## é¡¹ç›®èƒŒæ™¯

```mermaid
graph LR
    subgraph C++å±‚
        A[ScreenRecorder] --> B[MP4æ–‡ä»¶]
        C[AudioGrabber] --> B
    end
    
    subgraph Pythonå±‚
        B --> D[API Service]
        D --> E[Google AI SDK]
        E --> F[JSONç»“æ„åŒ–è¾“å‡º]
    end
    
    subgraph QMLå±‚
        F --> G[ç»“æœå±•ç¤º]
    end
```

ç°æœ‰å®ç°å·²å®Œæˆ **C++å±‚è§†é¢‘/éŸ³é¢‘é‡‡é›†ä¸MP4å°è£…**ï¼Œæœ¬éœ€æ±‚èšç„¦äºå°†è§†é¢‘ä¼ é€’ç»™Pythonå±‚å¹¶è°ƒç”¨Google Geminiè¿›è¡Œå†…å®¹åˆ†æã€‚

---

## å­é—®é¢˜ç›®å½•æ€»è§ˆ

| ç« èŠ‚ | æ¨¡å—å | ä¸»è¦ç›®æ ‡ | æŠ€æœ¯æ ˆ |
|:----:|:------:|:---------|:------:|
| 1 | è§†é¢‘æ–‡ä»¶ä¼ è¾“æ¥å£ | C++ â†’ Python æ–‡ä»¶è·¯å¾„ä¼ é€’ | pybind11 |
| 2 | Python APIæœåŠ¡æ¶æ„ | æœåŠ¡å±‚è®¾è®¡ä¸æ¥å£å®šä¹‰ | Python |
| 3 | Google AI SDKé›†æˆ | Gemini APIè°ƒç”¨å°è£… | google-genai |
| 4 | è§†é¢‘ä¸Šä¼ ä¸å¤„ç† | è§†é¢‘æ–‡ä»¶ä¸Šä¼ åˆ°Gemini | Files API |
| 5 | Promptå·¥ç¨‹æ¨¡å— | æ¨¡æ¿åŒ–Promptç®¡ç† | Python |
| 6 | JSONç»“æ„åŒ–è¾“å‡º | å“åº”è§£æä¸æ ¼å¼åŒ– | Pydantic |
| 7 | å¼‚æ­¥ä¸è¿›åº¦åé¦ˆ | æµå¼ç»“æœä¸è¿›åº¦é€šçŸ¥ | asyncio / signals |
| 8 | é”™è¯¯å¤„ç†ä¸é‡è¯• | å¥å£®çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ | Python |

---

## Chapter 1: è§†é¢‘æ–‡ä»¶ä¼ è¾“æ¥å£

> **ç›®æ ‡**: åœ¨C++å½•åˆ¶å®Œæˆåï¼Œå°†MP4æ–‡ä»¶è·¯å¾„å®‰å…¨ä¼ é€’ç»™Pythonå±‚ã€‚

### 1.1 æ¥å£è®¾è®¡

```mermaid
sequenceDiagram
    participant QML
    participant CPP as ScreenRecorder
    participant Binding as Pybind11
    participant Python as VideoService
    
    CPP->>CPP: å½•åˆ¶å®Œæˆç”ŸæˆMP4
    CPP->>Binding: è°ƒç”¨Pythonåˆ†ææ¥å£
    Binding->>Python: analyze_video(path)
    Python-->>Binding: è¿”å›åˆ†æç»“æœ
    Binding-->>QML: ä¿¡å·é€šçŸ¥
```

### 1.2 ä»»åŠ¡æ¸…å•

- **1.2.1** æ‰©å±• [bind_Screen_Recorder.cpp](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/cpp/bindings/bind_Screen_Recorder.cpp)ï¼Œæš´éœ²è§†é¢‘åˆ†æè§¦å‘æ–¹æ³•
- **1.2.2** è®¾è®¡ `AnalysisRequest` æ•°æ®ç»“æ„ï¼ˆæ–‡ä»¶è·¯å¾„ã€åˆ†æå‚æ•°ã€promptæ¨¡æ¿ï¼‰
- **1.2.3** å®ç°GILå®‰å…¨çš„å¼‚æ­¥è°ƒç”¨åŒ…è£…å™¨

### 1.3 å…³é”®çŸ¥è¯†ç‚¹

- pybind11 `py::gil_scoped_acquire` / `py::gil_scoped_release`
- C++ â†’ Python å›è°ƒçš„çº¿ç¨‹å®‰å…¨å¤„ç†
- æ–‡ä»¶è·¯å¾„çš„è·¨å¹³å°ç¼–ç ï¼ˆUTF-8ï¼‰

---

## Chapter 2: Python APIæœåŠ¡æ¶æ„

> **ç›®æ ‡**: æ„å»ºæ¸…æ™°çš„æœåŠ¡å±‚æ¶æ„ï¼Œå®ç°ä¸šåŠ¡é€»è¾‘ä¸AIè°ƒç”¨çš„åˆ†ç¦»ã€‚

### 2.1 æ¶æ„è®¾è®¡

```mermaid
classDiagram
    class VideoAnalysisService {
        +analyze_video(path, config) AnalysisResult
        -_upload_video(path) FileHandle
        -_call_gemini(file, prompt) str
        -_parse_response(raw) AnalysisResult
    }
    
    class GeminiClient {
        +upload_file(path) File
        +generate_content(prompt, files) Response
        +wait_for_processing(file) File
    }
    
    class PromptManager {
        +get_prompt(template_name) str
        +render_prompt(template, context) str
    }
    
    class ResponseParser {
        +parse_json(raw_text) dict
        +validate_schema(data) AnalysisResult
    }
    
    VideoAnalysisService --> GeminiClient
    VideoAnalysisService --> PromptManager
    VideoAnalysisService --> ResponseParser
```

### 2.2 ä»»åŠ¡æ¸…å•

- **2.2.1** åˆ›å»º `services/ai_analysis_service.py`
- **2.2.2** å®šä¹‰ `models/analysis_models.py`ï¼ˆè¯·æ±‚/å“åº”æ•°æ®æ¨¡å‹ï¼‰
- **2.2.3** åˆ›å»º `clients/gemini_client.py` å°è£…SDKè°ƒç”¨
- **2.2.4** æ›´æ–° `viewmodels/` å±‚æš´éœ²ç»™QML

### 2.3 ç›®å½•ç»“æ„é¢„è§ˆ

```
python/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ ai_analysis_service.py    # [NEW] AIåˆ†ææœåŠ¡
â”‚   â””â”€â”€ video_service.py          # [EXISTING] å½•åˆ¶æœåŠ¡
â”œâ”€â”€ clients/
â”‚   â””â”€â”€ gemini_client.py          # [NEW] Gemini SDKå°è£…
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ analysis_models.py        # [NEW] åˆ†ææ•°æ®æ¨¡å‹
â”‚   â””â”€â”€ video_models.py           # [EXISTING]
â””â”€â”€ viewmodels/
    â””â”€â”€ analysis_viewmodel.py     # [NEW] åˆ†æViewModel
```

---

## Chapter 3: Google AI SDKé›†æˆ

> **ç›®æ ‡**: é›†æˆæœ€æ–°çš„ `google-genai` åº“ï¼ˆGoogle Gen AI SDKï¼‰ï¼Œå°è£…Gemini APIè°ƒç”¨ã€‚

> [!IMPORTANT]
> æ—§åº“ `google-generativeai` å·²å¼ƒç”¨ï¼Œè¯·ä½¿ç”¨æœ€æ–°çš„ `google-genai`
> å®‰è£…å‘½ä»¤ï¼š`pip install --upgrade google-genai`

### 3.1 SDKåˆå§‹åŒ–æµç¨‹

```mermaid
flowchart TD
    A[å¯åŠ¨åº”ç”¨] --> B{æ£€æŸ¥API Key}
    B -->|å­˜åœ¨| C[åˆå§‹åŒ–SDK]
    B -->|ä¸å­˜åœ¨| D[æç¤ºç”¨æˆ·é…ç½®]
    C --> E[éªŒè¯Keyæœ‰æ•ˆæ€§]
    E -->|æœ‰æ•ˆ| F[SDKå°±ç»ª]
    E -->|æ— æ•ˆ| G[é”™è¯¯æç¤º]
```

### 3.2 ä»»åŠ¡æ¸…å•

- **3.2.1** é…ç½®ç®¡ç†ï¼šAPI Keyå®‰å…¨å­˜å‚¨ä¸è¯»å–
- **3.2.2** SDKåˆå§‹åŒ–å°è£… `GeminiClient.__init__()`
- **3.2.3** æ¨¡å‹é€‰æ‹©æ”¯æŒï¼ˆGemini 1.5 Flash / Pro / 2.0ï¼‰
- **3.2.4** è¯·æ±‚å‚æ•°é…ç½®ï¼ˆtemperature, top_p, etc.ï¼‰

### 3.3 ä»£ç ç¤ºä¾‹

```python
from google import genai

class GeminiClient:
    def __init__(self, api_key: str, model: str = "gemini-2.0-flash"):
        self.client = genai.Client(api_key=api_key)
        self.model = model
    
    def generate(self, prompt: str):
        return self.client.models.generate_content(
            model=self.model,
            contents=prompt
        )
```

---

## Chapter 4: è§†é¢‘ä¸Šä¼ ä¸å¤„ç†

> **ç›®æ ‡**: å®ç°è§†é¢‘æ–‡ä»¶ä¸Šä¼ åˆ°Gemini Files APIï¼Œå¹¶å¤„ç†ä¸Šä¼ çŠ¶æ€è½®è¯¢ã€‚

### 4.1 ä¸Šä¼ æµç¨‹

```mermaid
stateDiagram-v2
    [*] --> Uploading: upload_file()
    Uploading --> Processing: ä¸Šä¼ æˆåŠŸ
    Processing --> Active: å¤„ç†å®Œæˆ
    Processing --> Processing: è½®è¯¢ç­‰å¾…
    Active --> [*]: å¯ç”¨äºåˆ†æ
    
    Uploading --> Failed: ä¸Šä¼ å¤±è´¥
    Processing --> Failed: å¤„ç†è¶…æ—¶
    Failed --> [*]: æŠ›å‡ºå¼‚å¸¸
```

### 4.2 ä»»åŠ¡æ¸…å•

- **4.2.1** å®ç° `upload_file()` æ–¹æ³•
- **4.2.2** å®ç° `wait_for_processing()` è½®è¯¢é€»è¾‘
- **4.2.3** å¤„ç†å¤§æ–‡ä»¶ä¸Šä¼ ï¼ˆåˆ†å—/è¿›åº¦å›è°ƒï¼‰
- **4.2.4** æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆä¸Šä¼ å48å°æ—¶è‡ªåŠ¨åˆ é™¤ï¼‰

### 4.3 å…³é”®ä»£ç 

```python
import time
from google import genai

def upload_and_wait(self, file_path: str, timeout: int = 300):
    # ä½¿ç”¨æ–°SDKä¸Šä¼ æ–‡ä»¶
    file = self.client.files.upload(file=file_path)
    start = time.time()
    
    while file.state.name == "PROCESSING":
        time.sleep(5)
        file = self.client.files.get(name=file.name)
        
        if (time.time() - start) > timeout:
            raise TimeoutError("è§†é¢‘å¤„ç†è¶…æ—¶")
    
    if file.state.name == "FAILED":
        raise RuntimeError(f"è§†é¢‘å¤„ç†å¤±è´¥: {file.state}")
        
    return file
```

---

## Chapter 5: Promptå·¥ç¨‹æ¨¡å—

> **ç›®æ ‡**: è®¾è®¡æ¨¡æ¿åŒ–çš„Promptç³»ç»Ÿï¼Œæ”¯æŒçµæ´»çš„åˆ†æéœ€æ±‚é…ç½®ã€‚

### 5.1 Promptæ¨¡æ¿ç»“æ„

```mermaid
graph TD
    subgraph æ¨¡æ¿å±‚
        A[ç³»ç»ŸæŒ‡ä»¤ System] --> D[å®Œæ•´Prompt]
        B[ç”¨æˆ·ä»»åŠ¡ Task] --> D
        C[è¾“å‡ºæ ¼å¼ Format] --> D
    end
    
    subgraph å˜é‡æ³¨å…¥
        E[è§†é¢‘ä¸Šä¸‹æ–‡] --> B
        F[è‡ªå®šä¹‰è§„åˆ™] --> B
    end
```

### 5.2 ä»»åŠ¡æ¸…å•

- **5.2.1** åˆ›å»º `prompts/` ç›®å½•å­˜æ”¾æ¨¡æ¿æ–‡ä»¶
- **5.2.2** å®ç° `PromptManager` æ¨¡æ¿åŠ è½½ä¸æ¸²æŸ“
- **5.2.3** è®¾è®¡JSONè¾“å‡ºæ ¼å¼å®šä¹‰Schema
- **5.2.4** æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰Promptæ‰©å±•

### 5.3 æ¨¡æ¿ç¤ºä¾‹

```python
# prompts/video_analysis.py
SYSTEM_PROMPT = """
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è§†é¢‘å†…å®¹åˆ†æåŠ©æ‰‹ã€‚
è¯·æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºåˆ†æç»“æœã€‚
"""

OUTPUT_SCHEMA = """
{
    "summary": "è§†é¢‘å†…å®¹æ€»ç»“",
    "scenes": [
        {
            "timestamp": "00:00:00",
            "description": "åœºæ™¯æè¿°",
            "key_elements": ["å…ƒç´ 1", "å…ƒç´ 2"]
        }
    ],
    "tags": ["æ ‡ç­¾1", "æ ‡ç­¾2"]
}
"""
```

---

## Chapter 6: JSONç»“æ„åŒ–è¾“å‡º

> **ç›®æ ‡**: ç¡®ä¿AIè¾“å‡ºç¬¦åˆé¢„å®šä¹‰çš„JSON Schemaï¼Œå¹¶è¿›è¡ŒéªŒè¯ä¸è§£æã€‚

### 6.1 æ•°æ®æ¨¡å‹è®¾è®¡

```mermaid
classDiagram
    class AnalysisResult {
        +str summary
        +List~Scene~ scenes
        +List~str~ tags
        +datetime analyzed_at
    }
    
    class Scene {
        +str timestamp
        +str description
        +List~str~ key_elements
        +float confidence
    }
    
    class AnalysisError {
        +str error_code
        +str message
        +dict details
    }
    
    AnalysisResult "1" --> "*" Scene
```

### 6.2 ä»»åŠ¡æ¸…å•

- **6.2.1** ä½¿ç”¨Pydanticå®šä¹‰æ•°æ®æ¨¡å‹
- **6.2.2** å®ç°JSONè§£æä¸æå–ï¼ˆå¤„ç†markdownä»£ç å—ï¼‰
- **6.2.3** SchemaéªŒè¯ä¸é”™è¯¯å¤„ç†
- **6.2.4** è¾“å‡ºæ•°æ®åºåˆ—åŒ–ï¼ˆä¾›QMLæ¶ˆè´¹ï¼‰

### 6.3 Geminiç»“æ„åŒ–è¾“å‡ºé…ç½®

```python
# ä½¿ç”¨Geminiçš„response_schemaç‰¹æ€§
generation_config = {
    "response_mime_type": "application/json",
    "response_schema": AnalysisResult
}
```

---

## Chapter 7: å¼‚æ­¥ä¸è¿›åº¦åé¦ˆ

> **ç›®æ ‡**: å®ç°éé˜»å¡çš„åˆ†æè°ƒç”¨ï¼Œå¹¶æä¾›å®æ—¶è¿›åº¦åé¦ˆç»™UIå±‚ã€‚

### 7.1 å¼‚æ­¥æ¶æ„

```mermaid
sequenceDiagram
    participant QML
    participant ViewModel
    participant Service
    participant Gemini
    
    QML->>ViewModel: startAnalysis()
    ViewModel->>Service: analyze_async()
    
    loop è¿›åº¦æ›´æ–°
        Service-->>ViewModel: progress_updated(%)
        ViewModel-->>QML: progressChanged
    end
    
    Service->>Gemini: generate_content()
    Gemini-->>Service: streaming response
    Service-->>ViewModel: analysis_completed
    ViewModel-->>QML: resultReady
```

### 7.2 ä»»åŠ¡æ¸…å•

- **7.2.1** å®ç°å¼‚æ­¥åˆ†ææ–¹æ³• `analyze_async()`
- **7.2.2** è®¾è®¡è¿›åº¦å›è°ƒæœºåˆ¶
- **7.2.3** æµå¼å“åº”å¤„ç†ï¼ˆGemini Streamingï¼‰
- **7.2.4** ä¸C++ä¿¡å·æ§½ç³»ç»Ÿé›†æˆï¼ˆçº¿ç¨‹å®‰å…¨ï¼‰

### 7.3 è¿›åº¦é˜¶æ®µå®šä¹‰

| é˜¶æ®µ | è¿›åº¦èŒƒå›´ | æè¿° |
|:----:|:--------:|:-----|
| ä¸Šä¼ ä¸­ | 0-30% | è§†é¢‘æ–‡ä»¶ä¸Šä¼ åˆ°Gemini |
| å¤„ç†ä¸­ | 30-50% | ç­‰å¾…è§†é¢‘å¤„ç†å®Œæˆ |
| åˆ†æä¸­ | 50-90% | AIæ¨¡å‹åˆ†æè§†é¢‘å†…å®¹ |
| è§£æä¸­ | 90-100% | è§£æå¹¶éªŒè¯è¾“å‡ºæ ¼å¼ |

---

## Chapter 8: é”™è¯¯å¤„ç†ä¸é‡è¯•

> **ç›®æ ‡**: æ„å»ºå¥å£®çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§ã€‚

### 8.1 é”™è¯¯åˆ†ç±»

```mermaid
graph TB
    A[å¼‚å¸¸ç±»å‹] --> B[ç½‘ç»œå¼‚å¸¸]
    A --> C[APIå¼‚å¸¸]
    A --> D[æ–‡ä»¶å¼‚å¸¸]
    A --> E[è§£æå¼‚å¸¸]
    
    B --> B1[è¿æ¥è¶…æ—¶]
    B --> B2[DNSè§£æå¤±è´¥]
    
    C --> C1[API Keyæ— æ•ˆ]
    C --> C2[é…é¢è¶…é™]
    C --> C3[æ¨¡å‹ä¸å¯ç”¨]
    
    D --> D1[æ–‡ä»¶ä¸å­˜åœ¨]
    D --> D2[æ ¼å¼ä¸æ”¯æŒ]
    D --> D3[æ–‡ä»¶è¿‡å¤§]
    
    E --> E1[JSONæ ¼å¼é”™è¯¯]
    E --> E2[SchemaéªŒè¯å¤±è´¥]
```

### 8.2 ä»»åŠ¡æ¸…å•

- **8.2.1** å®šä¹‰è‡ªå®šä¹‰å¼‚å¸¸ç±»å±‚æ¬¡
- **8.2.2** å®ç°æŒ‡æ•°é€€é¿é‡è¯•æœºåˆ¶
- **8.2.3** é”™è¯¯ä¿¡æ¯æœ¬åœ°åŒ–ï¼ˆä¸­æ–‡æç¤ºï¼‰
- **8.2.4** é”™è¯¯æ—¥å¿—è®°å½•ä¸ä¸ŠæŠ¥

### 8.3 é‡è¯•ç­–ç•¥

```python
@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=2, max=30),
    retry=retry_if_exception_type((ConnectionError, TimeoutError))
)
async def call_gemini_with_retry(self, prompt, file):
    return await self.model.generate_content_async([prompt, file])
```

---

## ä¾èµ–å…³ç³»å›¾

```mermaid
graph TD
    C1[Chapter 1: ä¼ è¾“æ¥å£] --> C2[Chapter 2: æœåŠ¡æ¶æ„]
    C2 --> C3[Chapter 3: SDKé›†æˆ]
    C3 --> C4[Chapter 4: è§†é¢‘ä¸Šä¼ ]
    C2 --> C5[Chapter 5: Promptå·¥ç¨‹]
    C4 --> C6[Chapter 6: ç»“æ„åŒ–è¾“å‡º]
    C5 --> C6
    C6 --> C7[Chapter 7: å¼‚æ­¥åé¦ˆ]
    C3 --> C8[Chapter 8: é”™è¯¯å¤„ç†]
    C4 --> C8
    
    style C1 fill:#e1f5fe
    style C2 fill:#e1f5fe
    style C3 fill:#fff3e0
    style C4 fill:#fff3e0
    style C5 fill:#f3e5f5
    style C6 fill:#f3e5f5
    style C7 fill:#e8f5e9
    style C8 fill:#ffebee
```

---

## å¼€å‘ä¼˜å…ˆçº§å»ºè®®

| ä¼˜å…ˆçº§ | ç« èŠ‚ | ç†ç”± |
|:------:|:----:|:-----|
| ğŸ”´ P0 | Chapter 3 | SDKé›†æˆæ˜¯æ ¸å¿ƒåŸºç¡€ |
| ğŸ”´ P0 | Chapter 4 | è§†é¢‘ä¸Šä¼ æ˜¯å¿…è¦å‰ç½® |
| ğŸŸ  P1 | Chapter 2 | æœåŠ¡æ¶æ„å†³å®šä»£ç ç»„ç»‡ |
| ğŸŸ  P1 | Chapter 6 | è¾“å‡ºæ ¼å¼å½±å“ä¸‹æ¸¸æ¶ˆè´¹ |
| ğŸŸ¡ P2 | Chapter 1 | å¯å…ˆç”¨Pythonç›´æ¥æµ‹è¯• |
| ğŸŸ¡ P2 | Chapter 5 | åˆæœŸå¯ç¡¬ç¼–ç Prompt |
| ğŸŸ¢ P3 | Chapter 7 | åŠŸèƒ½è·‘é€šåå†ä¼˜åŒ– |
| ğŸŸ¢ P3 | Chapter 8 | åŠŸèƒ½è·‘é€šåå†å®Œå–„ |

---

## é™„å½•ï¼šæŠ€æœ¯é€‰å‹

| ç»„ä»¶ | æ¨èæ–¹æ¡ˆ | å¤‡é€‰æ–¹æ¡ˆ |
|:----:|:--------:|:--------:|
| AI SDK | google-genai | REST API ç›´æ¥è°ƒç”¨ |
| æ•°æ®æ ¡éªŒ | Pydantic v2 | dataclasses + json |
| å¼‚æ­¥æ¡†æ¶ | asyncio | threading |
| é‡è¯•åº“ | tenacity | æ‰‹åŠ¨å®ç° |
| æ—¥å¿— | loguru | logging |
