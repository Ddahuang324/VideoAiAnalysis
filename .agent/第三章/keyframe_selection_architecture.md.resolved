1# å…³é”®å¸§æ™ºèƒ½é€‰æ‹©æ¶æ„è®¾è®¡

> **æ ¸å¿ƒç›®æ ‡**ï¼šåœ¨ 1fps ä½å¸§ç‡å½•åˆ¶çš„åŸºç¡€ä¸Šï¼Œé€šè¿‡ AI é©±åŠ¨çš„å…³é”®å¸§ç­›é€‰ï¼Œ**è¿›ä¸€æ­¥å°† MP4 è§†é¢‘æ–‡ä»¶å¤§å°ç¼©å‡ 60-70%**ï¼ŒåŒæ—¶ä¿ç•™ 95%+ çš„æœ‰æ•ˆä¿¡æ¯ã€‚

---

## é—®é¢˜èƒŒæ™¯ä¸è§£å†³æ€è·¯

### ä¸ºä»€ä¹ˆéœ€è¦è¿›ä¸€æ­¥å‹ç¼©ï¼Ÿ

åœ¨ AI è§†é¢‘åˆ†æåœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å·²ç»é‡‡ç”¨äº† **1fps ä½å¸§ç‡å½•åˆ¶ç­–ç•¥**æ¥é™ä½æ•°æ®é‡ã€‚ç„¶è€Œï¼Œè¿™ä»ç„¶å­˜åœ¨å¤§é‡å†—ä½™ï¼š

```mermaid
flowchart LR
    subgraph Before["ä¼˜åŒ–å‰"]
        V1["15åˆ†é’Ÿè§†é¢‘<br/>1fps â†’ 900å¸§<br/>â‰ˆ 50MB"]
    end
    
    subgraph Problem["é—®é¢˜åˆ†æ"]
        P1["ğŸ”´ é™æ€ç”»é¢é‡å¤<br/>çº¦40%å†—ä½™"]
        P2["ğŸ”´ ä½ä»·å€¼å¸§æ®‹ç•™<br/>çº¦20%å†—ä½™"]
    end
    
    subgraph After["ä¼˜åŒ–å"]
        V2["å…³é”®å¸§åºåˆ—<br/>~300å¸§<br/>â‰ˆ 15MB"]
    end
    
    Before --> Problem --> After
```

### è§£å†³æ–¹æ¡ˆæ ¸å¿ƒæ€è·¯

æˆ‘ä»¬é‡‡ç”¨ **ä¸‰ç»´è¯„åˆ†ç³»ç»Ÿ** å¯¹æ¯ä¸€å¸§è¿›è¡Œæ™ºèƒ½è¯„ä¼°ï¼Œåªä¿ç•™çœŸæ­£æœ‰ä»·å€¼çš„å…³é”®å¸§ï¼š

| ç»´åº¦ | æ£€æµ‹ç›®æ ‡ | æŠ€æœ¯æ–¹æ¡ˆ | æƒé‡ |
|:----:|:---------|:---------|:----:|
| **åœºæ™¯å˜åŒ–** | ç”»é¢å†…å®¹æ˜¯å¦å‘ç”Ÿå˜åŒ– | MobileNetV3-Small | **45%** |
| **æ–‡å­—æ£€æµ‹** | ç”»é¢æ˜¯å¦åŒ…å«æœ‰ä»·å€¼æ–‡å­— | PaddleOCR PP-OCRv4 | **35%** |
| **è¿åŠ¨æ£€æµ‹** | ç”»é¢ä¸­ç‰©ä½“æ˜¯å¦åœ¨ç§»åŠ¨ | YOLOv8n + ByteTrack | **20%** |

---

## ç³»ç»Ÿæ¶æ„æ€»è§ˆ

æ•´ä½“æ¶æ„é‡‡ç”¨åˆ†å±‚è®¾è®¡ï¼Œä»è¾“å…¥åˆ°è¾“å‡ºç»å† **è§£ç  â†’ é¢„ç­›é€‰ â†’ æ¨¡å‹åˆ†æ â†’ è¯„åˆ† â†’ è¾“å‡º** äº”ä¸ªæ ¸å¿ƒé˜¶æ®µï¼š

```mermaid
flowchart TB
    subgraph Input["ğŸ“¥ è¾“å…¥å±‚"]
        MP4["MP4 è§†é¢‘æ–‡ä»¶<br/>900 å¸§ @ 1fps<br/>â‰ˆ 50MB"]
    end
    
    subgraph Decoder["ğŸ”“ è§£ç å±‚"]
        FFD["FFmpeg è§£ç å™¨"]
        FrameBuffer["å¸§ç¼“å†²é˜Ÿåˆ—"]
    end
    
    subgraph PreFilter["âš¡ é¢„ç­›é€‰å±‚ (å¿«é€Ÿè¿‡æ»¤)"]
        direction LR
        FastHist["å¿«é€Ÿç›´æ–¹å›¾<br/>åˆç­›"]
        Skip["è·³è¿‡é™æ€å¸§<br/>èŠ‚çœ40%è®¡ç®—"]
    end
    
    subgraph Analyzer["ğŸ§  AIæ¨¡å‹åˆ†æå¼•æ“"]
        direction TB
        SC["åœºæ™¯å˜åŒ–æ£€æµ‹å™¨<br/>MobileNetV3-Small"]
        MD["è¿åŠ¨æ£€æµ‹å™¨<br/>YOLOv8n + ByteTrack"]
        OCR["æ–‡å­—æ£€æµ‹å™¨<br/>PP-OCRv4"]
    end
    
    subgraph Scorer["ğŸ“Š æ™ºèƒ½è¯„åˆ†ç³»ç»Ÿ"]
        Calculator["ç»¼åˆè¯„åˆ†è®¡ç®—å™¨<br/>åŠ¨æ€æƒé‡"]
        Ranker["å¸§æ’åºå™¨"]
        Selector["Top-K é€‰æ‹©å™¨"]
    end
    
    subgraph Output["ğŸ“¤ è¾“å‡ºå±‚"]
        KF["å…³é”®å¸§åºåˆ—<br/>~300 å¸§"]
        NewMP4["ä¼˜åŒ–åè§†é¢‘<br/>â‰ˆ 15MB"]
    end
    
    MP4 --> FFD --> FrameBuffer
    FrameBuffer --> PreFilter
    PreFilter -->|å€™é€‰å¸§| SC & MD & OCR
    PreFilter -->|é™æ€å¸§| Skip
    SC & MD & OCR --> Calculator
    Calculator --> Ranker --> Selector --> KF --> NewMP4
    
    style Input fill:#e1f5fe
    style Output fill:#e8f5e9
    style Analyzer fill:#fff3e0
```

> [!IMPORTANT]
> **å‹ç¼©æ•ˆæœé¢„æœŸ**ï¼š900å¸§ â†’ ~300å¸§ = çº¦ **67% å‹ç¼©ç‡**ï¼Œæ–‡ä»¶å¤§å°ä» 50MB é™è‡³çº¦ 15MBã€‚

---

## ä¸‰ç»´è¯„åˆ†ä½“ç³»è¯¦è§£

æ¯ä¸€å¸§éƒ½ä¼šä»ä¸‰ä¸ªç»´åº¦è¿›è¡Œè¯„ä¼°ï¼Œæœ€ç»ˆç»¼åˆå¾—å‡ºè¯¥å¸§çš„"ä¿¡æ¯ä»·å€¼åˆ†æ•°"ï¼š

```mermaid
flowchart LR
    subgraph Scene["ğŸ¬ åœºæ™¯å˜åŒ–ç»´åº¦"]
        S1["MobileNetV3-Small<br/>æ·±åº¦ç‰¹å¾æå–"]
        S2["ä¼ ç»Ÿç›´æ–¹å›¾<br/>åº•å™ªåŸºå‡†"]
        S3["ä½™å¼¦ç›¸ä¼¼åº¦<br/>å˜åŒ–åˆ¤æ–­"]
    end
    
    subgraph Motion["ğŸ¯ è¿åŠ¨æ£€æµ‹ç»´åº¦"]
        M1["YOLOv8n<br/>ç›®æ ‡æ£€æµ‹"]
        M2["ByteTrack<br/>å¤šç›®æ ‡è·Ÿè¸ª"]
        M3["ä½ç§»å¼ºåº¦<br/>è¿åŠ¨è¯„ä¼°"]
    end
    
    subgraph TextOCR["ğŸ“ æ–‡å­—æ£€æµ‹ç»´åº¦"]
        T1["PP-OCRv4<br/>ç«¯åˆ°ç«¯è¯†åˆ«"]
        T2["æ–‡å­—ç½®ä¿¡åº¦"]
        T3["æ–‡å­—å¯†åº¦åˆ†å¸ƒ"]
    end
    
    S1 --> S2 --> S3
    M1 --> M2 --> M3
    T1 --> T2 --> T3
    
    style Scene fill:#bbdefb
    style Motion fill:#c8e6c9
    style TextOCR fill:#ffe0b2
```

---

## æ¨¡å—ä¸€ï¼šåœºæ™¯å˜åŒ–æ£€æµ‹

> [!NOTE]
> åœºæ™¯å˜åŒ–æ£€æµ‹ä½œä¸º"**å¼€å…³ä½**"ï¼Œå½“æ£€æµ‹åˆ°æ˜¾è‘—åœºæ™¯åˆ‡æ¢æ—¶ï¼Œè‡ªåŠ¨ä¿ç•™è¯¥å¸§ä½œä¸ºå…³é”®å¸§ã€‚

### æŠ€æœ¯æ–¹æ¡ˆ

é‡‡ç”¨ **MobileNetV3-Small + ä¼ ç»Ÿç›´æ–¹å›¾** æ··åˆç­–ç•¥ï¼š

- **MobileNetV3-Small**ï¼šæå– 1280 ç»´æ·±åº¦ç‰¹å¾å‘é‡ï¼Œç†è§£è¯­ä¹‰çº§åˆ«çš„åœºæ™¯å˜åŒ–
- **ä¼ ç»Ÿç›´æ–¹å›¾**ï¼šä½œä¸ºåº•å™ªåŸºå‡†ï¼Œå¿«é€Ÿè¿‡æ»¤æ˜æ˜¾ç›¸ä¼¼å¸§

```mermaid
flowchart TB
    subgraph Input["è¾“å…¥"]
        Frame["å½“å‰å¸§"]
        PrevFrame["å‰ä¸€å¸§"]
    end
    
    subgraph MobileNet["MobileNetV3-Small ç‰¹å¾æå–"]
        Backbone["Backbone<br/>æ·±åº¦å¯åˆ†ç¦»å·ç§¯"]
        Pool["Global Avg Pool"]
        Feature["1280ç»´ç‰¹å¾å‘é‡"]
    end
    
    subgraph Traditional["ä¼ ç»Ÿç›´æ–¹å›¾"]
        Hist["RGBç›´æ–¹å›¾"]
        Bhatta["å·´æ°è·ç¦»"]
    end
    
    subgraph Fusion["èåˆå†³ç­–"]
        Cosine["ä½™å¼¦ç›¸ä¼¼åº¦"]
        Weighted["åŠ æƒèåˆ<br/>Î±=0.7, Î²=0.3"]
        Score["åœºæ™¯å˜åŒ–åˆ†æ•° S"]
    end
    
    Frame --> Backbone --> Pool --> Feature
    PrevFrame --> Backbone
    Feature --> Cosine
    
    Frame --> Hist --> Bhatta
    PrevFrame --> Hist
    
    Cosine --> Weighted
    Bhatta --> Weighted
    Weighted --> Score
    
    style MobileNet fill:#e3f2fd
    style Traditional fill:#f3e5f5
```

### æ ¸å¿ƒç®—æ³•å®ç°

```cpp
class SceneChangeDetector {
public:
    struct Config {
        float modelWeight = 0.7f;      // MobileNetç‰¹å¾æƒé‡
        float histogramWeight = 0.3f;  // ä¼ ç»Ÿç›´æ–¹å›¾æƒé‡
        float resetThreshold = 0.35f;  // åœºæ™¯åˆ‡æ¢é˜ˆå€¼
    };
    
    float calculateScore(const Frame& prev, const Frame& curr) {
        // 1. MobileNetV3-Small ç‰¹å¾æå–
        auto prevFeature = mobileNet_.extractFeature(prev);  // [1280]
        auto currFeature = mobileNet_.extractFeature(curr);  // [1280]
        
        // 2. è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦
        float cosineSim = cosineSimilarity(prevFeature, currFeature);
        float modelDiff = 1.0f - cosineSim;
        
        // 3. ä¼ ç»Ÿç›´æ–¹å›¾å·®å¼‚ï¼ˆåº•å™ªåŸºå‡†ï¼‰
        float histDiff = compareHistograms(prev, curr, CV_COMP_BHATTACHARYYA);
        
        // 4. åŠ æƒèåˆ
        float score = modelDiff * config_.modelWeight 
                    + histDiff * config_.histogramWeight;
        
        return normalizeToScore(score);
    }
    
private:
    MobileNetV3Wrapper mobileNet_;
    Config config_;
};
```

---

## æ¨¡å—äºŒï¼šè¿åŠ¨æ£€æµ‹

> [!TIP]
> è¿åŠ¨æ£€æµ‹ä½œä¸º"**å¼•å¯¼ä½**"ï¼Œç¡®å®š"å“ªäº›åŒºåŸŸæœ‰ä»·å€¼"ã€‚è¿åŠ¨è¶Šå‰§çƒˆï¼Œè¯¥å¸§çš„ä¿¡æ¯ä»·å€¼è¶Šé«˜ã€‚

### æŠ€æœ¯æ–¹æ¡ˆ

é‡‡ç”¨ **YOLOv8n + ByteTrack** ç›®æ ‡çº§è·Ÿè¸ªï¼š

- **YOLOv8n**ï¼šè½»é‡çº§ç›®æ ‡æ£€æµ‹ï¼Œè¯†åˆ«ç”»é¢ä¸­çš„ç‰©ä½“
- **ByteTrack**ï¼šé«˜æ€§èƒ½å¤šç›®æ ‡è·Ÿè¸ªç®—æ³•ï¼Œè®¡ç®—ç‰©ä½“ä½ç§»

```mermaid
flowchart TB
    subgraph Detection["YOLOv8n ç›®æ ‡æ£€æµ‹"]
        Frame["è¾“å…¥å¸§"]
        YOLO["YOLOv8n<br/>nanoç‰ˆæœ¬"]
        Boxes["æ£€æµ‹æ¡†<br/>[x,y,w,h,cls,conf]"]
    end
    
    subgraph Tracking["ByteTrack è·Ÿè¸ª"]
        Associate["åŒˆç‰™åˆ©åŒ¹é…"]
        TrackState["è½¨è¿¹çŠ¶æ€<br/>New/Tracked/Lost"]
        TrackID["è½¨è¿¹IDåˆ†é…"]
    end
    
    subgraph Analysis["ä½ç§»åˆ†æ"]
        Center["ä¸­å¿ƒç‚¹è½¨è¿¹"]
        Velocity["é€Ÿåº¦è®¡ç®—"]
        Intensity["è¿åŠ¨å¼ºåº¦ M"]
    end
    
    Frame --> YOLO --> Boxes
    Boxes --> Associate --> TrackState --> TrackID
    TrackID --> Center --> Velocity --> Intensity
    
    style Detection fill:#e8f5e9
    style Tracking fill:#fff8e1
```

### è¿åŠ¨å¼ºåº¦è®¡ç®—

```cpp
class MotionDetector {
public:
    struct TrackInfo {
        int trackId;
        cv::Point2f center;
        cv::Point2f velocity;
        float confidence;
    };
    
    float calculateScore(const Frame& frame, FrameContext& ctx) {
        // 1. YOLOv8n ç›®æ ‡æ£€æµ‹
        auto detections = yolov8_.detect(frame);
        
        // 2. ByteTrack å¤šç›®æ ‡è·Ÿè¸ª
        auto tracks = byteTrack_.update(detections);
        
        // 3. è®¡ç®—è¿åŠ¨å¼ºåº¦
        float totalMotion = 0.0f;
        float maxConfidence = 0.0f;
        
        for (const auto& track : tracks) {
            float displacement = cv::norm(track.velocity);
            float weightedMotion = displacement * track.confidence;
            totalMotion += weightedMotion;
            maxConfidence = std::max(maxConfidence, track.confidence);
        }
        
        // 4. å½’ä¸€åŒ–è¯„åˆ†
        float motionScore = std::min(totalMotion / motionThreshold_, 1.0f);
        
        // 5. ç½®ä¿¡åº¦åŠ æƒ
        return motionScore * 0.7f + maxConfidence * 0.3f;
    }
    
private:
    YOLOv8nWrapper yolov8_;
    ByteTracker byteTrack_;
    float motionThreshold_ = 100.0f;  // åƒç´ /å¸§
};
```

---

## æ¨¡å—ä¸‰ï¼šæ–‡å­—æ£€æµ‹

> [!IMPORTANT]
> æ–‡å­—æ£€æµ‹æ˜¯**æ ¸å¿ƒè¯­ä¹‰ä½**ï¼Œæƒé‡æœ€é«˜ã€‚åŒ…å«é‡è¦æ–‡å­—ä¿¡æ¯çš„å¸§å…·æœ‰æœ€é«˜çš„ä¿ç•™ä¼˜å…ˆçº§ã€‚

### æŠ€æœ¯æ–¹æ¡ˆ

é‡‡ç”¨ **PaddleOCR PP-OCRv4** ç«¯åˆ°ç«¯è¯†åˆ«ï¼š

```mermaid
flowchart TB
    subgraph OCRPipeline["PP-OCRv4 Pipeline"]
        Frame["è¾“å…¥å¸§"]
        Det["æ–‡å­—æ£€æµ‹æ¨¡å‹<br/>DB++"]
        Boxes["æ–‡å­—åŒºåŸŸ"]
        Cls["æ–¹å‘åˆ†ç±»<br/>0Â°/180Â°"]
        Rec["æ–‡å­—è¯†åˆ«<br/>SVTR"]
        Text["è¯†åˆ«ç»“æœ<br/>[text, conf, box]"]
    end
    
    subgraph Analysis["è¯­ä¹‰åˆ†æ"]
        ConfAvg["å¹³å‡ç½®ä¿¡åº¦"]
        Density["æ–‡å­—å¯†åº¦<br/>area_ratio"]
        Semantic["è¯­ä¹‰ä»·å€¼è¯„ä¼°"]
    end
    
    subgraph Score["è¯„åˆ†è¾“å‡º"]
        Final["OCRè¯„åˆ† T"]
    end
    
    Frame --> Det --> Boxes --> Cls --> Rec --> Text
    Text --> ConfAvg & Density
    ConfAvg & Density --> Semantic --> Final
    
    style OCRPipeline fill:#ffe0b2
```

### æ–‡å­—å¯†åº¦è¯„åˆ†

```cpp
class TextDetector {
public:
    struct OCRResult {
        std::string text;
        float confidence;
        cv::Rect boundingBox;
    };
    
    float calculateScore(const Frame& frame) {
        // 1. PP-OCRv4 ç«¯åˆ°ç«¯è¯†åˆ«
        auto results = paddleOCR_.recognize(frame);
        
        if (results.empty()) {
            return 0.0f;  // æ— æ–‡å­—
        }
        
        // 2. è®¡ç®—æ–‡å­—åŒºåŸŸæ€»é¢ç§¯
        float totalTextArea = 0.0f;
        float totalConfidence = 0.0f;
        
        for (const auto& result : results) {
            totalTextArea += result.boundingBox.area();
            totalConfidence += result.confidence;
        }
        
        float frameArea = frame.width() * frame.height();
        
        // 3. æ–‡å­—å¯†åº¦ (é¢ç§¯å æ¯”)
        float density = totalTextArea / frameArea;
        float densityScore = std::min(density / 0.3f, 1.0f);  // 30%é¥±å’Œ
        
        // 4. å¹³å‡ç½®ä¿¡åº¦
        float avgConfidence = totalConfidence / results.size();
        
        // 5. èåˆè¯„åˆ†
        return densityScore * 0.6f + avgConfidence * 0.4f;
    }
    
private:
    PaddleOCRWrapper paddleOCR_;
};
```

---

## ç»¼åˆè¯„åˆ†ï¼šåŠ¨æ€æƒé‡ç­–ç•¥

ä¸åŒäºå›ºå®šæƒé‡ï¼Œæˆ‘ä»¬é‡‡ç”¨ **åŠ¨æ€æƒé‡** ç­–ç•¥ï¼Œæ ¹æ®å„ç»´åº¦çš„æ¿€æ´»ç¨‹åº¦è‡ªé€‚åº”è°ƒæ•´ï¼š

```mermaid
flowchart LR
    subgraph Inputs["ç»´åº¦åˆ†æ•°"]
        S["åœºæ™¯å˜åŒ– S"]
        M["è¿åŠ¨å¼ºåº¦ M"]
        T["æ–‡å­—å¯†åº¦ T"]
    end
    
    subgraph Weights["åŠ¨æ€æƒé‡è®¡ç®—"]
        Normalize["åˆ†æ•°å½’ä¸€åŒ–"]
        Softmax["Softmax<br/>æƒé‡åˆ†é…"]
        W["åŠ¨æ€æƒé‡<br/>[ws, wm, wt]"]
    end
    
    subgraph Base["åŸºç¡€æƒé‡"]
        Ws["åœºæ™¯å˜åŒ– 0.45"]
        Wt["æ–‡å­—æ£€æµ‹ 0.35"]
        Wm["è¿åŠ¨æ£€æµ‹ 0.20"]
    end
    
    subgraph Final["æœ€ç»ˆè¯„åˆ†"]
        Fusion["åŠ æƒèåˆ"]
        Score["Final Score"]
    end
    
    S & M & T --> Normalize --> Softmax --> W
    W --> Fusion
    Ws & Wm & Wt --> Fusion
    S & M & T --> Fusion --> Score
    
    style Base fill:#e1bee7
    style Final fill:#c8e6c9
```

### è¯„åˆ†å…¬å¼

```
# åŸºç¡€æƒé‡ (å˜åŒ–ä¼˜å…ˆ)
base_weights = [0.45, 0.35, 0.20]  # Scene, OCR, Motion

# åŠ¨æ€è°ƒæ•´å› å­
activation = softmax([S, T, M])
adjusted_weights = base_weights * (1 + Î± * activation)
adjusted_weights = normalize(adjusted_weights)

# æœ€ç»ˆè¯„åˆ†
FinalScore = S Ã— 0.45 + T Ã— 0.35 + M Ã— 0.20
```

> [!NOTE]
> **åœºæ™¯å˜åŒ–æƒé‡æœ€é«˜ (0.45)**ï¼Œç¡®ä¿ä»£ç ç¼–è¾‘ã€æ–‡æ¡£æ»šåŠ¨ç­‰ç»†å¾®å†…å®¹å˜åŒ–ä¸ä¼šè¢«é—æ¼ï¼›æ–‡å­—æ£€æµ‹æ¬¡ä¹‹ (0.35)ï¼Œè¿åŠ¨æ£€æµ‹æœ€ä½ (0.20)ã€‚

---

## ç±»è®¾è®¡æ¶æ„

æ•´ä½“é‡‡ç”¨ç­–ç•¥æ¨¡å¼ï¼Œä¾¿äºæ‰©å±•æ–°çš„è¯„åˆ†ç»´åº¦ï¼š

```mermaid
classDiagram
    class FrameAnalyzer {
        <<interface>>
        +analyze(frame, context) float
        +getBaseWeight() float
        +getName() string
    }
    
    class SceneChangeDetector {
        -MobileNetV3Wrapper mobileNet
        -Config config
        +analyze(frame, context) float
        +extractFeature(frame) vector~float~
    }
    
    class MotionDetector {
        -YOLOv8nWrapper yolov8
        -ByteTracker byteTrack
        +analyze(frame, context) float
        +getActiveTracks() vector~TrackInfo~
    }
    
    class TextDetector {
        -PaddleOCRWrapper paddleOCR
        +analyze(frame, context) float
        +getTextResults() vector~OCRResult~
    }
    
    class KeyFrameSelector {
        -vector~FrameAnalyzer*~ analyzers
        -DynamicWeightCalculator weightCalc
        +selectKeyFrames(videoPath) vector~int~
        -preFilter(frames) vector~Frame~
        -calculateFinalScore(scores) float
    }
    
    class ModelManager {
        -map~string,Model~ models
        +loadModel(name, path) bool
        +getModel(name) Model*
        +warmUp() void
    }
    
    FrameAnalyzer <|.. SceneChangeDetector
    FrameAnalyzer <|.. MotionDetector
    FrameAnalyzer <|.. TextDetector
    KeyFrameSelector o-- FrameAnalyzer
    KeyFrameSelector --> ModelManager
    SceneChangeDetector --> ModelManager
    MotionDetector --> ModelManager
    TextDetector --> ModelManager
```

---

## æ€§èƒ½ä¼˜åŒ–ï¼šC++ å·¥ç¨‹åŒ–åŠ é€Ÿæ–¹æ¡ˆ

> [!NOTE]
> æœ¬æ–¹æ¡ˆèšç„¦äº **C++ å·¥ç¨‹åŒ–æ‰‹æ®µ** è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ï¼Œé€šè¿‡æµæ°´çº¿è®¾è®¡ã€å¹¶è¡Œè®¡ç®—ã€å¼‚æ­¥å¤„ç†ç­‰æ–¹å¼æå‡ååé‡ï¼Œè€Œéæ¨¡å‹å±‚é¢çš„ä¼˜åŒ–ã€‚

### ä¸‰çº§æµæ°´çº¿æ¶æ„

é‡‡ç”¨ç»å…¸çš„ **ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼**ï¼Œå°†å¤„ç†æµç¨‹æ‹†åˆ†ä¸ºä¸‰ä¸ªç‹¬ç«‹é˜¶æ®µï¼Œå®ç°å¹¶è¡Œæ‰§è¡Œï¼š

```mermaid
flowchart LR
    subgraph Stage1["Stage 1: è§£ç é˜¶æ®µ"]
        direction TB
        FFmpeg["FFmpeg è§£ç "]
        Queue1["å¸§é˜Ÿåˆ—<br/>capacity=32"]
    end
    
    subgraph Stage2["Stage 2: é¢„ç­›é€‰é˜¶æ®µ"]
        direction TB
        Filter["å¿«é€Ÿç›´æ–¹å›¾<br/>è¿‡æ»¤é™æ€å¸§"]
        Queue2["å€™é€‰å¸§é˜Ÿåˆ—<br/>capacity=16"]
    end
    
    subgraph Stage3["Stage 3: æ¨¡å‹æ¨ç†é˜¶æ®µ"]
        direction TB
        Parallel["å¹¶è¡Œæ¨ç†æ± <br/>3ä¸ªæ£€æµ‹å™¨"]
        Score["è¯„åˆ†èšåˆ"]
    end
    
    Stage1 -->|"å¼‚æ­¥ä¼ é€’"| Stage2 -->|"å¼‚æ­¥ä¼ é€’"| Stage3
    
    style Stage1 fill:#bbdefb
    style Stage2 fill:#c8e6c9
    style Stage3 fill:#fff3e0
```

### å¹¶è¡Œè®¡ç®—ç­–ç•¥

ä¸‰ä¸ªæ£€æµ‹æ¨¡å—åœ¨ Stage 3 ä¸­ **å¹¶è¡Œæ‰§è¡Œ**ï¼Œäº’ä¸é˜»å¡ï¼š

```mermaid
flowchart TB
    subgraph Input["è¾“å…¥"]
        Frame["å€™é€‰å¸§"]
    end
    
    subgraph Parallel["å¹¶è¡Œæ£€æµ‹ (std::async)"]
        direction LR
        T1["çº¿ç¨‹1<br/>åœºæ™¯å˜åŒ–æ£€æµ‹"]
        T2["çº¿ç¨‹2<br/>è¿åŠ¨æ£€æµ‹"]
        T3["çº¿ç¨‹3<br/>æ–‡å­—æ£€æµ‹"]
    end
    
    subgraph Sync["åŒæ­¥ç‚¹"]
        Future["std::future<br/>ç­‰å¾…æ‰€æœ‰ç»“æœ"]
        Aggregate["è¯„åˆ†èšåˆ"]
    end
    
    Frame --> T1 & T2 & T3
    T1 & T2 & T3 --> Future --> Aggregate
    
    style Parallel fill:#e8f5e9
```

### æ ¸å¿ƒå®ç°ä»£ç 

```cpp
class ParallelFrameAnalyzer {
public:
    struct AnalysisResult {
        float sceneScore;
        float motionScore;
        float textScore;
        float finalScore;
    };
    
    AnalysisResult analyzeFrame(const Frame& frame, FrameContext& ctx) {
        // 1. å¯åŠ¨ä¸‰ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰
        auto sceneFuture = std::async(std::launch::async, [&]() {
            return sceneDetector_.calculateScore(ctx.prevFrame, frame);
        });
        
        auto motionFuture = std::async(std::launch::async, [&]() {
            return motionDetector_.calculateScore(frame, ctx);
        });
        
        auto textFuture = std::async(std::launch::async, [&]() {
            return textDetector_.calculateScore(frame);
        });
        
        // 2. ç­‰å¾…æ‰€æœ‰ç»“æœï¼ˆåŒæ­¥ç‚¹ï¼‰
        AnalysisResult result;
        result.sceneScore = sceneFuture.get();
        result.motionScore = motionFuture.get();
        result.textScore = textFuture.get();
        
        // 3. è®¡ç®—åŠ æƒæœ€ç»ˆåˆ†æ•°
        result.finalScore = calculateWeightedScore(result);
        
        return result;
    }
    
private:
    SceneChangeDetector sceneDetector_;
    MotionDetector motionDetector_;
    TextDetector textDetector_;
};
```

### æµæ°´çº¿æ§åˆ¶å™¨

```cpp
class PipelineController {
public:
    void process(const std::string& videoPath) {
        // Stage 1: è§£ç çº¿ç¨‹
        std::thread decoderThread([&]() {
            FFmpegDecoder decoder(videoPath);
            while (auto frame = decoder.nextFrame()) {
                frameQueue_.push(std::move(frame));  // é˜»å¡é˜Ÿåˆ—
            }
            frameQueue_.setComplete();
        });
        
        // Stage 2: é¢„ç­›é€‰çº¿ç¨‹
        std::thread filterThread([&]() {
            while (auto frame = frameQueue_.pop()) {
                if (preFilter_.shouldProcess(*frame)) {
                    candidateQueue_.push(std::move(frame));
                }
                // é™æ€å¸§ç›´æ¥ä¸¢å¼ƒï¼Œå‡å°‘åç»­è®¡ç®—
            }
            candidateQueue_.setComplete();
        });
        
        // Stage 3: å¹¶è¡Œåˆ†æï¼ˆä¸»çº¿ç¨‹æˆ–çº¿ç¨‹æ± ï¼‰
        while (auto frame = candidateQueue_.pop()) {
            auto result = analyzer_.analyzeFrame(*frame, context_);
            if (result.finalScore > threshold_) {
                keyFrames_.push_back(frame->index);
            }
        }
        
        decoderThread.join();
        filterThread.join();
    }
    
private:
    BlockingQueue<Frame> frameQueue_{32};      // è§£ç ç¼“å†²
    BlockingQueue<Frame> candidateQueue_{16};  // å€™é€‰ç¼“å†²
    PreFilter preFilter_;
    ParallelFrameAnalyzer analyzer_;
};
```

### æ€§èƒ½æŒ‡æ ‡é¢„æœŸ

| è§†é¢‘æ—¶é•¿ | åŸå§‹å¸§æ•° | é¢„ç­›é€‰å | å•çº¿ç¨‹å¤„ç† | æµæ°´çº¿+å¹¶è¡Œ | åŠ é€Ÿæ¯” |
|:--------:|:--------:|:--------:|:----------:|:-----------:|:------:|
| **1 åˆ†é’Ÿ** | 60 | ~36 | ~8 ç§’ | ~3 ç§’ | 2.7x |
| **5 åˆ†é’Ÿ** | 300 | ~180 | ~35 ç§’ | ~12 ç§’ | 2.9x |
| **15 åˆ†é’Ÿ** | 900 | ~540 | ~100 ç§’ | ~35 ç§’ | 2.9x |
| **1 å°æ—¶** | 3600 | ~2160 | ~400 ç§’ | ~140 ç§’ | 2.9x |

> [!TIP]
> é€šè¿‡ **æµæ°´çº¿ + å¹¶è¡Œè®¡ç®—**ï¼Œåœ¨ä¸æ”¹å˜æ¨¡å‹çš„æƒ…å†µä¸‹å®ç°çº¦ **3x åŠ é€Ÿ**ã€‚

---

## æ¨¡å‹è°ƒç”¨è§„æ ¼

### æ¨¡å‹æ¸…å•

| æ¨¡å‹ | ç‰ˆæœ¬ | è¾“å…¥å°ºå¯¸ | æ¨¡å‹å¤§å° | æ¨ç†æ¡†æ¶ | å•å¸§å»¶è¿Ÿ |
|:----:|:----:|:--------:|:--------:|:--------:|:--------:|
| **MobileNetV3-Small** | v3 | 224Ã—224 | ~2.5 MB | ONNX Runtime | 5-10ms |
| **YOLOv8n** | 8.0 | 640Ã—640 | ~6.3 MB | ONNX Runtime | 15-30ms |
| **PP-OCRv4 Det** | v4 | åŠ¨æ€ | ~4.4 MB | PaddleInference | 20-40ms |
| **PP-OCRv4 Rec** | v4 | åŠ¨æ€ | ~10.5 MB | PaddleInference | 30-60ms |

### ä¾èµ–é¡¹

```plaintext
# æ¨ç†æ¡†æ¶
- ONNX Runtime >= 1.17.0
- PaddlePaddle >= 2.6.0 (ç”¨äº PP-OCRv4)

# C++ åº“
- OpenCV >= 4.8.0
- Eigen >= 3.4.0
```

---

## é£é™©ä¸ç¼“è§£æªæ–½

> [!WARNING]
> å¹¶å‘è®¾è®¡å¼•å…¥åŒæ­¥å¤æ‚æ€§ï¼Œéœ€å…³æ³¨ä»¥ä¸‹é£é™©ã€‚

| é£é™©é¡¹ | ä¸¥é‡ç¨‹åº¦ | ç¼“è§£æªæ–½ |
|:------:|:--------:|:---------:|
| **é˜Ÿåˆ—ç§¯å‹** | ğŸŸ¡ ä¸­ | è®¾ç½®å®¹é‡ä¸Šé™ï¼Œç”Ÿäº§è€…é˜»å¡ç­‰å¾… |
| **å†…å­˜å³°å€¼** | ğŸŸ¡ ä¸­ | æ§åˆ¶é˜Ÿåˆ—å¤§å°ï¼ŒåŠæ—¶é‡Šæ”¾å·²å¤„ç†å¸§ |
| **çº¿ç¨‹å®‰å…¨** | ğŸ”´ é«˜ | ä½¿ç”¨çº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ï¼Œé¿å…å…±äº«å¯å˜çŠ¶æ€ |
| **æ¨¡å‹åŠ è½½æ…¢** | ğŸŸ¢ ä½ | åº”ç”¨å¯åŠ¨æ—¶é¢„åŠ è½½æ‰€æœ‰æ¨¡å‹ |
| **OCR æˆä¸ºç“¶é¢ˆ** | ğŸŸ¡ ä¸­ | é¢„ç­›é€‰å‡è´Ÿ + å¯è€ƒè™‘æ‰¹é‡ OCR |

---

## å‹ç¼©æ•ˆæœæ€»ç»“

````carousel
### å‹ç¼©å‰ vs å‹ç¼©å

| æŒ‡æ ‡ | å‹ç¼©å‰ (1fps) | å‹ç¼©å (å…³é”®å¸§) | æ•ˆæœ |
|:----:|:-------------:|:---------------:|:----:|
| 15åˆ†é’Ÿè§†é¢‘å¸§æ•° | 900å¸§ | ~300å¸§ | â†“67% |
| æ–‡ä»¶å¤§å° | ~50MB | ~15MB | â†“70% |
| ä¿¡æ¯ä¿ç•™ç‡ | 100% | 95%+ | å‡ ä¹æ— æŸ |

<!-- slide -->

### æŠ€æœ¯ä¼˜åŠ¿

| ç»´åº¦ | ä¼ ç»Ÿæ–¹æ¡ˆ | æ¨¡å‹é©±åŠ¨æ–¹æ¡ˆ |
|:----:|:--------:|:------------:|
| åœºæ™¯ç†è§£ | åƒç´ çº§ | **è¯­ä¹‰çº§** âœ… |
| è¿åŠ¨æ£€æµ‹ | å…¨å±€å˜åŒ– | **ç›®æ ‡çº§è·Ÿè¸ª** âœ… |
| æ–‡å­—æ£€æµ‹ | è¾¹ç¼˜ç»Ÿè®¡ | **ç«¯åˆ°ç«¯OCR** âœ… |
| ç²¾åº¦ | ä¸­ç­‰ | **é«˜** âœ… |

<!-- slide -->

### æœ€ç»ˆæ•ˆæœ

```
åŸå§‹è§†é¢‘ (1fps, 15åˆ†é’Ÿ)
â””â”€â”€ 900 å¸§ Ã— ~55KB/å¸§ â‰ˆ 50MB

å…³é”®å¸§ç­›é€‰å
â””â”€â”€ 300 å¸§ Ã— ~50KB/å¸§ â‰ˆ 15MB

æ€»å‹ç¼©ç‡: 70%
ä¿¡æ¯ä¿ç•™: 95%+
```
````

---

## ç»“è®º

æœ¬æ¶æ„é€šè¿‡å¼•å…¥æ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œå°†å…³é”®å¸§é€‰æ‹©ä» **åƒç´ çº§æ¯”è¾ƒ** å‡çº§ä¸º **è¯­ä¹‰çº§ç†è§£**ï¼š

1. **åœºæ™¯å˜åŒ–** - MobileNetV3-Small æå–æ·±åº¦ç‰¹å¾ï¼Œç†è§£åœºæ™¯å˜åŒ–è¯­ä¹‰
2. **è¿åŠ¨æ£€æµ‹** - YOLOv8n + ByteTrack å®ç°ç›®æ ‡çº§è¿åŠ¨è·Ÿè¸ª
3. **æ–‡å­—æ£€æµ‹** - PP-OCRv4 ç«¯åˆ°ç«¯è¯†åˆ«ï¼Œç²¾ç¡®è¯„ä¼°ä¿¡æ¯å¯†åº¦

é…åˆ **åŠ¨æ€æƒé‡ç­–ç•¥** å’Œ **å¤šçº§ä¼˜åŒ–**ï¼Œåœ¨ä¿æŒå®æ—¶æ€§çš„åŒæ—¶ï¼Œå®ç°æ›´ç²¾å‡†çš„å…³é”®å¸§ç­›é€‰ã€‚

> [!IMPORTANT]
> **é¢„æœŸæ•ˆæœ**ï¼šåœ¨ 1fps å½•åˆ¶åŸºç¡€ä¸Šï¼Œè¿›ä¸€æ­¥å‹ç¼© **60-70%**ï¼Œå°† 15 åˆ†é’Ÿè§†é¢‘ä» 50MB é™è‡³çº¦ 15MBï¼ŒåŒæ—¶ä¿¡æ¯ä¿ç•™ç‡è¾¾åˆ° **95%+**ã€‚
