# ZeroMQ 性能架构优化 - 任务清单

## 阶段一：ZeroMQ 基础设施搭建 (核心架构)

### 1. ZeroMQ 通信层基础设施
- [ ] 1.1 定义 ZMQ 消息格式
  - [ ] 定义 `FrameMessage` 结构（原始帧流）
  - [ ] 定义 `KeyFrameMetadata` 结构（关键帧元数据）
  - [ ] 实现消息序列化/反序列化（含 CRC32 校验）
- [ ] 1.2 实现 `FramePublisher` 类
  - [ ] PUB socket 初始化（tcp://*:5555）
  - [ ] 非阻塞发送逻辑（`dontwait` 模式）
  - [ ] 丢帧统计与日志
- [ ] 1.3 实现 `FrameSubscriber` 类
  - [ ] SUB socket 初始化（tcp://localhost:5555）
  - [ ] 带超时接收逻辑
  - [ ] 消息反序列化与校验
- [ ] 1.4 实现 `KeyFramePublisher` 类
  - [ ] PUSH socket 初始化（tcp://localhost:5556）
  - [ ] 元数据发送逻辑
- [ ] 1.5 实现 `KeyFrameSubscriber` 类
  - [ ] PULL socket 初始化（tcp://*:5556）
  - [ ] 元数据接收逻辑

### 2. ScreenRecorder 进程改造
- [ ] 2.1 新增发布线程
  - [ ] 创建 `publishLoop()` 方法
  - [ ] 集成 `FramePublisher`
  - [ ] 在 `captureLoop()` 中添加帧发布队列推送（1 行改动）
- [ ] 2.2 实现环形帧缓冲区
  - [ ] 创建 `RingFrameBuffer` 类
  - [ ] 在采集线程中缓存原始帧
  - [ ] 实现基于 `frame_id` 的 O(1) 查找
- [ ] 2.3 新增关键帧接收线程
  - [ ] 创建 `keyframeReceiveLoop()` 方法
  - [ ] 集成 `KeyFrameSubscriber`
  - [ ] 从环形缓冲区查找原始帧
- [ ] 2.4 新增精简编码线程
  - [ ] 创建 `keyframeEncodeLoop()` 方法
  - [ ] 实现关键帧专用编码器
  - [ ] 输出 `keyframes.mp4` 文件

### 3. KeyFrameAnalyzer 独立进程创建
- [ ] 3.1 创建独立进程入口
  - [ ] 新建 `KeyFrameAnalyzerService.cpp` 主程序
  - [ ] 实现进程启动/停止逻辑
  - [ ] 配置文件加载（模型路径、参数等）
- [ ] 3.2 实现帧接收线程
  - [ ] 集成 `FrameSubscriber`
  - [ ] 实现 `receiveLoop()` 方法
  - [ ] 推送到帧缓冲队列
- [ ] 3.3 实现检测线程
  - [ ] 集成现有 [StandardFrameAnalyzer](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/cpp/src/core/KeyFrame/FrameAnaylzer/StandardFrameAnalyzer.cpp#18-24)
  - [ ] 实现 `detectLoop()` 方法（并行检测）
  - [ ] 推送到评分队列
- [ ] 3.4 实现评分线程
  - [ ] 集成现有 [FrameScorer](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/cpp/include/core/KeyFrame/FrameAnaylzer/FrameScorer.h#46-48) 和 [DynamicCalculator](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/cpp/include/core/KeyFrame/FrameAnaylzer/DynamicCalculator.h#30-31)
  - [ ] 实现 `scoreLoop()` 方法
  - [ ] 推送到选择队列
- [ ] 3.5 实现关键帧选择线程
  - [ ] 实现 `selectLoop()` 方法（滑动窗口 Top-K）
  - [ ] 推送到发布队列
- [ ] 3.6 实现元数据发布线程
  - [ ] 集成 `KeyFramePublisher`
  - [ ] 实现 `publishLoop()` 方法
  - [ ] 可选：集成 AI API 客户端

---

## 阶段二：流控与稳定性优化

### 4. 自适应流控机制
- [ ] 4.1 实现 `AdaptiveFrameReceiver` 类
  - [ ] 队列水位监控（HIGH/LOW_WATER_MARK）
  - [ ] 动态跳帧比例调整
  - [ ] 集成到 AI 进程接收线程
- [ ] 4.2 实现队列积压监控
  - [ ] 添加队列大小统计
  - [ ] 日志告警机制
  - [ ] 性能指标上报

### 5. 错误处理与容错
- [ ] 5.1 进程间通信异常处理
  - [ ] ZMQ 连接失败重试机制
  - [ ] 消息校验失败处理
  - [ ] 网络超时处理
- [ ] 5.2 环形缓冲区溢出处理
  - [ ] 帧覆盖告警
  - [ ] 缓冲区大小动态调整
- [ ] 5.3 进程崩溃恢复
  - [ ] AI 进程崩溃不影响录制
  - [ ] 录制进程崩溃的数据保护

---

## 阶段三：性能优化（可选）

### 6. 内存池优化
- [ ] 6.1 实现 `MultiDimensionScorePool`
  - [ ] 对象池设计（预分配 + 复用）
  - [ ] 线程安全的 acquire/release 接口
  - [ ] 集成到 [StandardFrameAnalyzer](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/cpp/src/core/KeyFrame/FrameAnaylzer/StandardFrameAnalyzer.cpp#18-24)
- [ ] 6.2 实现特征向量内存池
  - [ ] 固定大小数组池
  - [ ] SIMD 对齐缓冲区
  - [ ] 集成到 [SceneChangeDetector](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/cpp/include/core/KeyFrame/Detectors/SceneChangeDetector.h#35-37)

### 7. SIMD 向量化
- [ ] 7.1 优化 [DynamicCalculator](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/cpp/include/core/KeyFrame/FrameAnaylzer/DynamicCalculator.h#30-31) 累加计算
  - [ ] 使用 AVX/SSE 指令集
  - [ ] 性能基准测试
- [ ] 7.2 优化余弦相似度计算
  - [ ] 向量化点积计算
  - [ ] 集成到 [SceneChangeDetector](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/cpp/include/core/KeyFrame/Detectors/SceneChangeDetector.h#35-37)

### 8. 批处理推理
- [ ] 8.1 扩展 [SceneChangeDetector](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/cpp/include/core/KeyFrame/Detectors/SceneChangeDetector.h#35-37) 批处理接口
  - [ ] 实现 `detectBatch()` 方法
  - [ ] ONNX Runtime 批量推理
- [ ] 8.2 扩展 [MotionDetector](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/cpp/include/core/KeyFrame/Detectors/MotionDetector.h#59-67) 批处理接口
  - [ ] 实现 `detectBatch()` 方法
  - [ ] 批量后处理优化

### 9. 算法优化
- [ ] 9.1 优化时间约束检查
  - [ ] 使用 `std::set` 维护有序时间戳
  - [ ] 二分查找替代线性遍历
  - [ ] 性能对比测试
- [ ] 9.2 优化 [KeyFrameDetector](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/cpp/include/core/KeyFrame/FrameAnaylzer/KeyFrameDetector.h#12-62) 排序
  - [ ] 评估部分排序（`std::nth_element`）
  - [ ] 堆优化（`std::priority_queue`）

---

## 阶段四：测试与验证

### 10. 单元测试
- [ ] 10.1 ZMQ 通信层测试
  - [ ] 消息序列化/反序列化测试
  - [ ] PUB/SUB 通信测试
  - [ ] PUSH/PULL 通信测试
- [ ] 10.2 环形缓冲区测试
  - [ ] 并发读写测试
  - [ ] 溢出覆盖测试
- [ ] 10.3 自适应跳帧测试
  - [ ] 队列水位触发测试
  - [ ] 跳帧比例调整测试

### 11. 集成测试
- [ ] 11.1 双进程端到端测试
  - [ ] 完整录制流程测试
  - [ ] 关键帧回传验证
  - [ ] 输出文件验证（全量 + 精简）
- [ ] 11.2 性能压力测试
  - [ ] 高帧率场景测试（60 FPS）
  - [ ] 长时间运行稳定性测试
  - [ ] 内存泄漏检测
- [ ] 11.3 故障注入测试
  - [ ] AI 进程崩溃恢复测试
  - [ ] 网络延迟模拟测试
  - [ ] 队列积压测试

### 12. 性能基准测试
- [ ] 12.1 建立性能基线
  - [ ] 单进程方案性能测试
  - [ ] 双进程方案性能测试
  - [ ] 对比分析报告
- [ ] 12.2 优化效果验证
  - [ ] 内存池优化前后对比
  - [ ] SIMD 优化前后对比
  - [ ] 批处理优化前后对比

---

## 阶段五：文档与部署

### 13. 文档完善
- [ ] 13.1 更新架构文档
  - [ ] 双进程架构图
  - [ ] 通信协议文档
  - [ ] 配置参数说明
- [ ] 13.2 编写部署指南
  - [ ] 依赖安装（ZeroMQ）
  - [ ] 编译配置
  - [ ] 运行参数说明
- [ ] 13.3 编写运维手册
  - [ ] 监控指标说明
  - [ ] 常见问题排查
  - [ ] 性能调优建议

### 14. 生产部署准备
- [ ] 14.1 配置管理
  - [ ] 配置文件模板
  - [ ] 环境变量支持
- [ ] 14.2 日志与监控
  - [ ] 结构化日志输出
  - [ ] 性能指标采集
  - [ ] 告警规则配置
- [ ] 14.3 容器化（可选）
  - [ ] Dockerfile 编写
  - [ ] Docker Compose 配置
  - [ ] Kubernetes 部署配置

---

## 优先级说明

| 优先级 | 阶段 | 说明 |
|:------|:----|:----|
| 🔴 **P0** | 阶段一 | 核心功能，必须完成 |
| 🟡 **P1** | 阶段二 | 稳定性保障，强烈建议 |
| 🟢 **P2** | 阶段三 | 性能优化，可选 |
| 🔵 **P3** | 阶段四 | 质量保证，建议完成 |
| ⚪ **P4** | 阶段五 | 文档与部署，长期维护 |

---

## 当前进度

- [x] 需求分析与架构设计
- [x] 综合优化文档编写
- [ ] 开始实施...
