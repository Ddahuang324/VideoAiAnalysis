# 视频采集编码与AI分析进程分离实施路线图

## 📋 项目概述

本文档将"进程分离架构设计"拆分为可执行的子任务，每个任务都有明确的交付物和验收标准。

**总体目标**: 将当前单体架构的视频录制和AI分析功能分离为两个独立的C++进程，并通过Pybind11暴露给Python层调用。

**预计工期**: 8-11个工作日

---

## 🎯 Phase 0: 准备工作与环境搭建

### 0. 前期准备
- [ ] 0.1 代码备份与分支管理
  - [ ] 创建新分支 `feature/process-separation`
  - [ ] 备份当前可运行版本
  - [ ] 设置Git里程碑标记
- [ ] 0.2 依赖库检查
  - [ ] 验证ZeroMQ版本 (>= 4.3.0)
  - [ ] 验证Pybind11版本 (>= 2.10.0)
  - [ ] 检查CMake配置是否支持多目标编译
- [ ] 0.3 设计文档评审
  - [ ] 团队评审架构设计文档
  - [ ] 确认技术方案可行性
  - [ ] 明确接口契约

---

## 🏗️ Phase 1: C++ 进程分离基础设施

### 1. 创建进程目录结构
- [ ] 1.1 创建RecorderProcess目录
  - [ ] `cpp/processes/recorder/` 目录
  - [ ] `RecorderProcessMain.cpp` 入口文件
  - [ ] `RecorderAPI.h/cpp` 接口定义
  - [ ] [CMakeLists.txt](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/CMakeLists.txt) 构建配置
- [ ] 1.2 创建AnalyzerProcess目录
  - [ ] `cpp/processes/analyzer/` 目录
  - [ ] `AnalyzerProcessMain.cpp` 入口文件
  - [ ] `AnalyzerAPI.h/cpp` 接口定义
  - [ ] [CMakeLists.txt](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/CMakeLists.txt) 构建配置
- [ ] 1.3 创建IPC基础设施目录
  - [ ] `cpp/ipc/` 目录
  - [ ] `IPCServer.h/cpp` 控制服务器
  - [ ] `IPCClient.h/cpp` 客户端基类
  - [ ] [Protocol.h](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/cpp/include/core/MQInfra/Protocol.h) 命令协议定义

### 2. IPC通信层实现
- [ ] 2.1 实现IPCServer（ZMQ REQ/REP模式）
  - [ ] 命令注册机制
  - [ ] JSON消息序列化/反序列化
  - [ ] 错误处理与超时机制
  - [ ] 单元测试（echo命令测试）
- [ ] 2.2 实现RecorderProcessClient
  - [ ] `connect()` 连接到录制进程
  - [ ] `start()` 启动录制命令
  - [ ] `stop()` 停止录制命令
  - [ ] `getStatus()` 查询状态
  - [ ] `getStats()` 获取统计信息
- [ ] 2.3 实现AnalyzerProcessClient
  - [ ] `connect()` 连接到分析进程
  - [ ] `start()` 启动分析命令
  - [ ] `stop()` 停止分析命令
  - [ ] `getStatus()` 查询状态
  - [ ] `getStats()` 获取统计信息
- [ ] 2.4 定义命令协议
  - [ ] 录制进程命令集（START, STOP, PAUSE, RESUME, GET_STATUS）
  - [ ] 分析进程命令集（START, STOP, GET_STATUS, SET_CONFIG）
  - [ ] 响应格式定义（成功/失败/错误码）

### 3. RecorderProcess核心实现
- [ ] 3.1 RecorderAPI接口实现
  - [ ] [initialize()](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/cpp/src/core/ScreenRecorder/ProcessLayer/FFmpegWrapper.cpp#54-117) 初始化录制组件
  - [ ] `start()` 启动录制管线
  - [ ] `pause()/resume()` 暂停/恢复
  - [ ] `stop()` 停止录制
  - [ ] `shutdown()` 清理资源
- [ ] 3.2 RecordingPipeline管线封装
  - [ ] 集成现有 `FrameGrabberThread`
  - [ ] 集成现有 `FrameEncoder`
  - [ ] 集成现有 [FFmpegWrapper](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/cpp/src/core/ScreenRecorder/ProcessLayer/FFmpegWrapper.cpp#49-50)
  - [ ] 集成现有 `FramePublisher`（ZMQ发布）
  - [ ] 状态机管理（Idle → Recording → Paused → Stopped）
- [ ] 3.3 RecorderProcessMain进程入口
  - [ ] 命令行参数解析（`--config`, `--control-port`）
  - [ ] 配置文件加载（JSON格式）
  - [ ] IPC服务器启动（监听控制命令）
  - [ ] 主循环与信号处理（SIGINT/SIGTERM）
  - [ ] 日志系统集成
- [ ] 3.4 编译与独立运行测试
  - [ ] 修改根CMakeLists.txt添加RecorderProcess目标
  - [ ] 编译生成 `RecorderProcess.exe`
  - [ ] 命令行启动测试
  - [ ] 验证ZMQ帧发布功能

### 4. AnalyzerProcess核心实现
- [ ] 4.1 AnalyzerAPI接口实现
  - [ ] [initialize()](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/cpp/src/core/ScreenRecorder/ProcessLayer/FFmpegWrapper.cpp#54-117) 初始化分析组件
  - [ ] `start()` 启动分析管线
  - [ ] `stop()` 停止分析
  - [ ] `shutdown()` 清理资源
- [ ] 4.2 AnalysisPipeline管线封装
  - [ ] 集成现有 `FrameSubscriber`（ZMQ订阅）
  - [ ] 集成现有 [KeyFrameAnalyzerService](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/cpp/include/core/KeyFrame/KeyFrameAnalyzerService.h#62-63)
  - [ ] 集成现有 [FrameAnalyzer](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/cpp/include/core/KeyFrame/KeyFrameAnalyzerService.h#62-63)（三维检测）
  - [ ] 集成现有 `KeyFrameMetaDataPublisher`
  - [ ] 状态机管理
- [ ] 4.3 AnalyzerProcessMain进程入口
  - [ ] 命令行参数解析（`--config`, `--control-port`, `--model-path`）
  - [ ] 配置文件加载
  - [ ] IPC服务器启动
  - [ ] 主循环与信号处理
  - [ ] 日志系统集成
- [ ] 4.4 编译与独立运行测试
  - [ ] 修改根CMakeLists.txt添加AnalyzerProcess目标
  - [ ] 编译生成 `AnalyzerProcess.exe`
  - [ ] 命令行启动测试
  - [ ] 验证ZMQ帧订阅功能

### 5. 进程间集成测试
- [ ] 5.1 双进程启动测试
  - [ ] 手动启动RecorderProcess
  - [ ] 手动启动AnalyzerProcess
  - [ ] 验证ZMQ通道连接成功
- [ ] 5.2 端到端数据流测试
  - [ ] RecorderProcess采集并发布帧
  - [ ] AnalyzerProcess接收并分析帧
  - [ ] 验证关键帧元数据回传
  - [ ] 检查数据完整性（无丢帧）
- [ ] 5.3 性能基准测试
  - [ ] 测试帧传输延迟（目标 < 10ms）
  - [ ] 测试CPU占用（双进程总和 vs 原单进程）
  - [ ] 测试内存占用
- [ ] 5.4 异常处理测试
  - [ ] 模拟RecorderProcess崩溃
  - [ ] 模拟AnalyzerProcess崩溃
  - [ ] 验证进程重启恢复机制

---

## 🐍 Phase 2: Pybind11 绑定层

### 6. 创建新的Pybind11模块
- [ ] 6.1 重构绑定目录结构
  - [ ] `cpp/bindings/recorder/` 录制进程绑定
  - [ ] `cpp/bindings/analyzer/` 分析进程绑定
  - [ ] `cpp/bindings/common/` 公共类型绑定
- [ ] 6.2 实现RecorderModule绑定
  - [ ] 绑定 `RecorderProcessClient` 类
  - [ ] 绑定 `RecorderAPI::Config` 结构体
  - [ ] 绑定 `RecordingStatus` 枚举
  - [ ] 绑定 `RecordingStats` 结构体
  - [ ] 导出为 `recorder_module.pyd`
- [ ] 6.3 实现AnalyzerModule绑定
  - [ ] 绑定 `AnalyzerProcessClient` 类
  - [ ] 绑定 `AnalyzerAPI::Config` 结构体
  - [ ] 绑定 `AnalysisStatus` 枚举
  - [ ] 绑定 `AnalysisStats` 结构体
  - [ ] 导出为 `analyzer_module.pyd`
- [ ] 6.4 Python侧测试
  - [ ] 编写 `test_recorder_module.py`
  - [ ] 编写 `test_analyzer_module.py`
  - [ ] 验证类型转换正确性
  - [ ] 验证异常传播机制

---

## 🎨 Phase 3: Python 层架构重构

### 7. 基础设施层（Infrastructure Layer）
- [ ] 7.1 实现ProcessManager
  - [ ] `start_recorder()` 启动录制进程
  - [ ] `start_analyzer()` 启动分析进程
  - [ ] `stop_all()` 停止所有进程
  - [ ] `restart_process()` 重启指定进程
  - [ ] `_wait_for_ready()` 等待进程就绪
  - [ ] `_monitor_health()` 健康检查线程
- [ ] 7.2 实现ConfigManager
  - [ ] 加载配置文件（YAML/JSON）
  - [ ] 环境变量覆盖机制
  - [ ] 配置验证逻辑
  - [ ] 默认配置生成
- [ ] 7.3 实现LogManager
  - [ ] 统一日志格式
  - [ ] 多进程日志聚合
  - [ ] 日志文件轮转

### 8. 服务层（Service Layer）
- [ ] 8.1 实现RecorderService
  - [ ] [initialize()](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/cpp/src/core/ScreenRecorder/ProcessLayer/FFmpegWrapper.cpp#54-117) 初始化录制服务
  - [ ] `start_recording()` 开始录制业务逻辑
  - [ ] `stop_recording()` 停止录制业务逻辑
  - [ ] `get_recording_info()` 获取录制信息
  - [ ] 事件回调处理（状态变更、错误）
- [ ] 8.2 实现AnalyzerService
  - [ ] [initialize()](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/cpp/src/core/ScreenRecorder/ProcessLayer/FFmpegWrapper.cpp#54-117) 初始化分析服务
  - [ ] `start_analysis()` 开始分析业务逻辑
  - [ ] `stop_analysis()` 停止分析业务逻辑
  - [ ] `get_keyframe_results()` 获取关键帧结果
  - [ ] 事件回调处理
- [ ] 8.3 实现HistoryService
  - [ ] SQLite数据库初始化
  - [ ] 保存录制记录
  - [ ] 查询历史记录
  - [ ] 删除历史记录

### 9. 视图模型层（ViewModel Layer）
- [ ] 9.1 重构RecorderViewModel
  - [ ] 依赖注入 `ProcessManager` 和 `RecorderService`
  - [ ] 实现 `status` 属性（绑定QML）
  - [ ] 实现 `progress` 属性（绑定QML）
  - [ ] 实现 `startRecording()` 槽函数
  - [ ] 实现 `stopRecording()` 槽函数
  - [ ] 实现 `pauseRecording()` 槽函数
  - [ ] 信号发射逻辑（statusChanged, progressChanged）
- [ ] 9.2 重构AnalyzerViewModel
  - [ ] 依赖注入 `ProcessManager` 和 [AnalyzerService](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/cpp/include/core/KeyFrame/KeyFrameAnalyzerService.h#62-63)
  - [ ] 实现 `analysisStatus` 属性
  - [ ] 实现 `keyframeCount` 属性
  - [ ] 实现 `startAnalysis()` 槽函数
  - [ ] 实现 `stopAnalysis()` 槽函数
  - [ ] 信号发射逻辑
- [ ] 9.3 实现HistoryViewModel
  - [ ] 历史记录列表模型
  - [ ] 搜索过滤逻辑
  - [ ] 删除记录逻辑

### 10. 依赖注入与初始化
- [ ] 10.1 实现ServiceLocator模式
  - [ ] 单例服务注册
  - [ ] 服务解析逻辑
- [ ] 10.2 修改main.py启动流程
  - [ ] 初始化 `ProcessManager`
  - [ ] 初始化各个Service
  - [ ] 创建ViewModel并注入依赖
  - [ ] 注册到QML上下文
- [ ] 10.3 单元测试
  - [ ] `test_process_manager.py`
  - [ ] `test_recorder_service.py`
  - [ ] `test_analyzer_service.py`

---

## 🎨 Phase 4: QML 界面适配（可选）

### 11. QML界面更新
- [ ] 11.1 更新RecorderPage.qml
  - [ ] 绑定新的 `RecorderViewModel`
  - [ ] 显示进程状态指示器
  - [ ] 错误提示UI
- [ ] 11.2 更新AnalyzerPage.qml
  - [ ] 绑定新的 `AnalyzerViewModel`
  - [ ] 关键帧结果展示
- [ ] 11.3 添加HistoryPage.qml
  - [ ] 历史记录列表
  - [ ] 搜索框
  - [ ] 删除按钮

---

## 🧪 Phase 5: 集成测试与优化

### 12. 端到端测试
- [ ] 12.1 功能测试
  - [ ] 启动应用 → 启动录制 → 启动分析 → 停止录制 → 查看结果
  - [ ] 暂停/恢复录制功能
  - [ ] 历史记录保存与查询
- [ ] 12.2 压力测试
  - [ ] 长时间录制测试（> 1小时）
  - [ ] 高帧率测试（60fps）
  - [ ] 内存泄漏检测
- [ ] 12.3 异常测试
  - [ ] 进程崩溃恢复
  - [ ] 网络中断恢复（ZMQ重连）
  - [ ] 磁盘空间不足处理

### 13. 性能优化
- [ ] 13.1 ZMQ通信优化
  - [ ] 评估共享内存方案（大帧传输）
  - [ ] 调整ZMQ缓冲区大小
  - [ ] 启用ZMQ压缩（如需要）
- [ ] 13.2 进程启动优化
  - [ ] 预热机制（提前启动进程）
  - [ ] 懒加载模型（延迟加载ONNX）
- [ ] 13.3 资源占用优化
  - [ ] 调整线程池大小
  - [ ] 优化内存分配策略

### 14. 文档与交付
- [ ] 14.1 技术文档
  - [ ] 进程架构说明文档
  - [ ] API接口文档
  - [ ] 部署指南
- [ ] 14.2 用户文档
  - [ ] 使用手册更新
  - [ ] 故障排查指南
- [ ] 14.3 代码审查
  - [ ] 代码规范检查
  - [ ] 安全审计
  - [ ] 性能审计

---

## 📊 验收标准

### 功能验收
- ✅ RecorderProcess和AnalyzerProcess可独立启动
- ✅ Python层可通过Pybind11控制两个进程
- ✅ 录制和分析功能正常工作
- ✅ 关键帧检测结果正确

### 性能验收
- ✅ 帧传输延迟 < 10ms
- ✅ CPU占用不超过原架构的120%
- ✅ 内存占用不超过原架构的150%

### 稳定性验收
- ✅ 连续运行1小时无崩溃
- ✅ 进程崩溃后可自动恢复
- ✅ 无内存泄漏

---

## 🚀 快速开始指南

### 开发者快速上手
1. 切换到 `feature/process-separation` 分支
2. 阅读 [process_separation_analysis.md](file:///C:/Users/Administrator/.gemini/antigravity/brain/81c9b9f3-e462-46a6-abfd-92ebe25e046f/process_separation_analysis.md) 设计文档
3. 从 Phase 1 开始，按顺序完成任务
4. 每完成一个Phase，提交代码并标记里程碑

### 任务优先级
- **P0（必须完成）**: Phase 1, Phase 2, Phase 3
- **P1（重要）**: Phase 5.12（端到端测试）
- **P2（可选）**: Phase 4（QML界面）, Phase 5.13（性能优化）

---

## 📅 时间估算

| Phase | 任务 | 预计工时 | 依赖 |
|-------|------|---------|------|
| Phase 0 | 准备工作 | 0.5天 | - |
| Phase 1 | C++进程分离 | 4-5天 | Phase 0 |
| Phase 2 | Pybind11绑定 | 1天 | Phase 1 |
| Phase 3 | Python层重构 | 2-3天 | Phase 2 |
| Phase 4 | QML界面适配 | 0.5-1天 | Phase 3 |
| Phase 5 | 测试与优化 | 1-2天 | Phase 3 |
| **总计** | | **9-12.5天** | |

---

## ⚠️ 风险提示

1. **ZMQ性能瓶颈**: 如遇到严重延迟，需切换到共享内存方案
2. **进程同步复杂**: 建议先实现单向控制，再实现双向同步
3. **Python层重构**: 建议增量重构，保持向后兼容

---

## 🎯 下一步行动

1. **立即开始**: Phase 0 - 创建分支并备份代码
2. **第一周目标**: 完成 Phase 1（C++进程分离）
3. **第二周目标**: 完成 Phase 2-3（绑定层和Python重构）
4. **第三周目标**: 完成 Phase 5（测试与优化）
