# Google Gemini API é›†æˆåˆ†ææ–‡æ¡£

## ğŸ“‹ éœ€æ±‚æ¦‚è¿°

### æ ¸å¿ƒåŠŸèƒ½éœ€æ±‚

æœ¬æ–‡æ¡£æ—¨åœ¨åˆ†æå¦‚ä½•åœ¨ç°æœ‰çš„ **AIè§†é¢‘åˆ†æç³»ç»Ÿ** ä¸­é›†æˆ Google Gemini APIï¼Œå®ç°ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

1. **å¤šçº§ Prompt æ¡†æ¶**ï¼šè®¾è®¡çµæ´»çš„å¤šå±‚æ¬¡æç¤ºè¯ä½“ç³»
2. **AI JSON è¾“å‡ºæ ¼å¼çº¦å®š**ï¼šå®šä¹‰æ ‡å‡†åŒ–çš„ JSON å“åº”æ ¼å¼
3. **æ ¼å¼è§£ææœºåˆ¶**ï¼šå¯é åœ°è§£æå’ŒéªŒè¯ AI è¿”å›çš„ JSON æ•°æ®
4. **å…³é”®å¸§è§†é¢‘å‘é€**ï¼šå°†æå–çš„å…³é”®å¸§è§†é¢‘å‘é€ç»™ Gemini API
5. **å†…å®¹è¯†åˆ«ä¸åˆ†æ**ï¼šè·å–å¹¶å¤„ç† Gemini è¿”å›çš„è§†é¢‘åˆ†æç»“æœ

### é¡¹ç›®èƒŒæ™¯

å½“å‰ç³»ç»Ÿå·²å…·å¤‡ä»¥ä¸‹èƒ½åŠ›ï¼š

- âœ… **è§†é¢‘å½•åˆ¶ä¸ç¼–ç **ï¼šC++ å®ç°çš„é«˜æ€§èƒ½å±å¹•å½•åˆ¶
- âœ… **å…³é”®å¸§æå–**ï¼šåŸºäºåœºæ™¯å˜åŒ–ã€è¿åŠ¨æ£€æµ‹ã€æ–‡æœ¬è¯†åˆ«çš„æ™ºèƒ½å…³é”®å¸§æ£€æµ‹
- âœ… **æ•°æ®åº“æ¶æ„**ï¼šSQLite æ•°æ®åº“å­˜å‚¨å½•åˆ¶è®°å½•ã€å…³é”®å¸§è§†é¢‘ã€Prompt æ¨¡æ¿ã€AI åˆ†æç»“æœ
- âœ… **æœåŠ¡å±‚æ¶æ„**ï¼šPython æœåŠ¡å±‚å°è£… C++ æ¨¡å—ï¼Œæä¾›ä¸šåŠ¡é€»è¾‘
- âœ… **Prompt æ¨¡æ¿ç³»ç»Ÿ**ï¼šå·²æœ‰ [PromptTemplate](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/python/database/models.py#39-52) æ•°æ®æ¨¡å‹å’Œ DAO å±‚

---

## ğŸ¯ æŠ€æœ¯æ–¹æ¡ˆåˆ†æ

### æ–¹æ¡ˆä¸€ï¼šç›´æ¥é›†æˆ Google Generative AI SDK

#### ä¼˜åŠ¿
- âœ… **å®˜æ–¹æ”¯æŒ**ï¼šä½¿ç”¨ `google-generativeai` Python SDKï¼ˆå·²åœ¨ [requirements.txt](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/requirements.txt) ä¸­ï¼‰
- âœ… **ç®€å•æ˜“ç”¨**ï¼šAPI å°è£…å®Œå–„ï¼Œæ–‡æ¡£é½å…¨
- âœ… **å¿«é€Ÿå¼€å‘**ï¼šæ— éœ€å¤„ç†åº•å±‚ HTTP è¯·æ±‚ç»†èŠ‚
- âœ… **è‡ªåŠ¨é‡è¯•**ï¼šSDK å†…ç½®é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

#### åŠ£åŠ¿
- âš ï¸ **çµæ´»æ€§å—é™**ï¼šå— SDK ç‰ˆæœ¬æ›´æ–°å½±å“
- âš ï¸ **ä¾èµ–ç®¡ç†**ï¼šå¢åŠ é¡¹ç›®ä¾èµ–

#### é€‚ç”¨åœºæ™¯
**æ¨èç”¨äºæœ¬é¡¹ç›®**ï¼Œå› ä¸ºç³»ç»Ÿå·²å®‰è£… `google-generativeai>=0.3.0`ï¼Œå¯å¿«é€Ÿå®ç°åŠŸèƒ½ã€‚

---

### æ–¹æ¡ˆäºŒï¼šåŸºäº REST API çš„è‡ªå®šä¹‰å®ç°

#### ä¼˜åŠ¿
- âœ… **å®Œå…¨æ§åˆ¶**ï¼šå¯è‡ªå®šä¹‰è¯·æ±‚æ ¼å¼ã€è¶…æ—¶ã€é‡è¯•ç­–ç•¥
- âœ… **è½»é‡çº§**ï¼šæ— éœ€é¢å¤– SDK ä¾èµ–
- âœ… **è·¨è¯­è¨€**ï¼šå¯åœ¨ C++ å±‚å®ç°ï¼ˆä½¿ç”¨ libcurlï¼‰

#### åŠ£åŠ¿
- âš ï¸ **å¼€å‘æˆæœ¬é«˜**ï¼šéœ€æ‰‹åŠ¨å¤„ç†è®¤è¯ã€è¯·æ±‚æ„å»ºã€é”™è¯¯å¤„ç†
- âš ï¸ **ç»´æŠ¤è´Ÿæ‹…**ï¼šAPI å˜æ›´éœ€æ‰‹åŠ¨é€‚é…

#### é€‚ç”¨åœºæ™¯
é€‚ç”¨äºéœ€è¦æè‡´æ€§èƒ½ä¼˜åŒ–æˆ–è·¨è¯­è¨€é›†æˆçš„åœºæ™¯ã€‚

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```mermaid
graph TB
    subgraph "QML UI Layer"
        A[AnalyzerViewModel]
    end
    
    subgraph "Python Service Layer"
        B[AnalyzerService]
        C[GeminiService]
        D[HistoryService]
    end
    
    subgraph "Business Logic"
        E[PromptBuilder]
        F[ResponseParser]
        G[VideoPreprocessor]
    end
    
    subgraph "Data Access Layer"
        H[PromptTemplateDAO]
        I[AIAnalysisDAO]
        J[KeyFrameDAO]
    end
    
    subgraph "External Services"
        K[Google Gemini API]
    end
    
    subgraph "C++ Core"
        L[KeyFrameAnalyzer]
        M[VideoEncoder]
    end
    
    A --> B
    B --> C
    B --> D
    C --> E
    C --> F
    C --> G
    C --> K
    E --> H
    F --> I
    G --> J
    B --> L
    L --> M
```

### æ ¸å¿ƒç»„ä»¶è®¾è®¡

#### 1. GeminiServiceï¼ˆæ–°å¢æœåŠ¡ï¼‰

**èŒè´£**ï¼š
- å°è£… Google Gemini API è°ƒç”¨é€»è¾‘
- ç®¡ç† API å¯†é’¥å’Œé…ç½®
- å¤„ç†è§†é¢‘ä¸Šä¼ å’Œåˆ†æè¯·æ±‚
- å®ç°é‡è¯•å’Œé”™è¯¯å¤„ç†æœºåˆ¶

**æ¥å£è®¾è®¡**ï¼š
```python
class GeminiService:
    def __init__(self, api_key: str, model_name: str = "gemini-2.0-flash-exp")
    def analyze_video(self, video_path: str, prompt: str) -> Dict[str, Any]
    def analyze_video_with_template(self, video_path: str, template_id: str, variables: Dict) -> Dict[str, Any]
    def upload_video(self, video_path: str) -> str  # è¿”å› file_uri
    def wait_for_file_active(self, file_uri: str, timeout: int = 300) -> bool
```

---

#### 2. PromptBuilderï¼ˆæ–°å¢ç»„ä»¶ï¼‰

**èŒè´£**ï¼š
- å®ç°å¤šçº§ Prompt æ¡†æ¶
- æ”¯æŒ Prompt æ¨¡æ¿å˜é‡æ›¿æ¢
- æ„å»ºç»“æ„åŒ–çš„ JSON Schema çº¦æŸ

**å¤šçº§ Prompt æ¡†æ¶è®¾è®¡**ï¼š

```mermaid
graph LR
    A[System Prompt<br/>ç³»ç»Ÿè§’è‰²å®šä¹‰<br/>å›ºå®š] --> B[Task Prompt<br/>åœºæ™¯ä»»åŠ¡æè¿°<br/>ç”¨æˆ·æ§åˆ¶]
    B --> C[Context Prompt<br/>è§†é¢‘å…ƒæ•°æ®<br/>è‡ªåŠ¨ç”Ÿæˆ]
    C --> D[Output Format Prompt<br/>JSONæ ¼å¼çº¦æŸ<br/>å›ºå®š]
    D --> E[Final Prompt]
    
    style B fill:#3498DB,stroke:#2980B9,stroke-width:3px,color:#fff
```

**å±‚çº§èŒè´£è¯´æ˜**ï¼š

| å±‚çº§ | åç§° | æ§åˆ¶æ–¹å¼ | å­˜å‚¨ä½ç½® | ç¤ºä¾‹ |
|-----|------|---------|---------|------|
| 1 | System Prompt | ç³»ç»Ÿå›ºå®š | ä»£ç å¸¸é‡ | "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è§†é¢‘å†…å®¹åˆ†æåŠ©æ‰‹" |
| 2 | **Task Prompt** | **ç”¨æˆ·æ§åˆ¶** | **SQLite `prompt_template` è¡¨** | **"è¿™æ˜¯ç¼–ç¨‹ç®—æ³•è§†é¢‘ï¼Œè¯·åˆ†æä»£ç é€»è¾‘..."** |
| 3 | Context Prompt | è‡ªåŠ¨ç”Ÿæˆ | è¿è¡Œæ—¶æ„å»º | "è§†é¢‘æ—¶é•¿: 120ç§’, å…³é”®å¸§æ•°: 50" |
| 4 | Output Format | ç³»ç»Ÿå›ºå®š | ä»£ç å¸¸é‡ | JSON Schema å®šä¹‰ |

**ç”¨æˆ·åœºæ™¯åˆ†ç±»è®¾è®¡**ï¼š

é€šè¿‡ `prompt_template` è¡¨çš„ `category` å­—æ®µå®ç°åœºæ™¯åˆ†ç±»ï¼š

- `coding_algorithm` - ç¼–ç¨‹å¼€å‘ï¼ˆä»£ç ç¼–å†™ã€ç®—æ³•è®²è§£ã€è°ƒè¯•ï¼‰
- `meeting` - ä¼šè®®è®¨è®ºï¼ˆå›¢é˜Ÿä¼šè®®ã€å¤´è„‘é£æš´ã€é¡¹ç›®è¯„å®¡ï¼‰
- `teaching` - æ•™å­¦è®²åº§ï¼ˆè¯¾ç¨‹è®²è§£ã€çŸ¥è¯†åˆ†äº«ã€åŸ¹è®­ï¼‰
- `gaming` - æ¸¸æˆå½•åˆ¶ï¼ˆæ¸¸æˆå®å†µã€æ”»ç•¥æ¼”ç¤ºï¼‰
- `general` - é€šç”¨åˆ†æï¼ˆé»˜è®¤åœºæ™¯ï¼‰

**å®ç°ä»£ç **ï¼š
```python
class PromptBuilder:
    # ç¬¬ä¸€çº§ï¼šç³»ç»Ÿæç¤ºè¯ï¼ˆå›ºå®šï¼‰
    SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è§†é¢‘å†…å®¹åˆ†æåŠ©æ‰‹ã€‚
ä½ çš„ä»»åŠ¡æ˜¯åˆ†æè§†é¢‘å†…å®¹å¹¶æå–å…³é”®ä¿¡æ¯ã€‚"""
    
    # ç¬¬å››çº§ï¼šè¾“å‡ºæ ¼å¼æç¤ºè¯ï¼ˆå›ºå®šï¼‰
    OUTPUT_FORMAT_PROMPT = """è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¾“å‡ºç»“æœï¼š
{
  "summary": "è§†é¢‘å†…å®¹æ‘˜è¦",
  "key_findings": [
    {"category": "åˆ†ç±»", "title": "æ ‡é¢˜", "content": "å†…å®¹", "confidence": 85}
  ],
  "timestamp_events": [
    {"timestamp": 12.5, "event_type": "highlight", "title": "äº‹ä»¶æ ‡é¢˜", "description": "æè¿°"}
  ],
  "metadata": {"duration": 120.5, "scene_count": 15}
}"""
    
    def __init__(self, prompt_dao: PromptTemplateDAO):
        self.prompt_dao = prompt_dao
        self.logger = get_logger("PromptBuilder")
    
    def build_prompt(
        self, 
        scenario_category: str,  # ç”¨æˆ·é€‰æ‹©çš„åœºæ™¯ç±»åˆ«
        video_context: Dict[str, Any],
        custom_variables: Dict[str, str] = None
    ) -> str:
        """æ„å»ºå®Œæ•´çš„å¤šçº§ Prompt
        
        Args:
            scenario_category: åœºæ™¯ç±»åˆ«ï¼ˆç”¨æˆ·æ§åˆ¶ï¼‰ï¼Œå¦‚ 'coding_algorithm', 'meeting'
            video_context: è§†é¢‘å…ƒæ•°æ®ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
            custom_variables: è‡ªå®šä¹‰å˜é‡ï¼ˆå¯é€‰ï¼‰
        
        Returns:
            str: å®Œæ•´çš„ Prompt
        """
        # ç¬¬ä¸€çº§ï¼šç³»ç»Ÿæç¤ºè¯ï¼ˆå›ºå®šï¼‰
        prompt_parts = [self.SYSTEM_PROMPT]
        
        # ç¬¬äºŒçº§ï¼šä»»åŠ¡æç¤ºè¯ï¼ˆç”¨æˆ·æ§åˆ¶ï¼Œä»æ•°æ®åº“è¯»å–ï¼‰
        task_template = self.prompt_dao.get_default(category=scenario_category)
        if not task_template:
            self.logger.warning(f"No template for category: {scenario_category}, using general")
            task_template = self.prompt_dao.get_default(category="general")
        
        if task_template:
            task_prompt = self.prompt_dao.render_prompt(task_template, custom_variables or {})
            prompt_parts.append(f"**åˆ†æä»»åŠ¡ï¼š**\n{task_prompt}")
        
        # ç¬¬ä¸‰çº§ï¼šä¸Šä¸‹æ–‡æç¤ºè¯ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
        context_prompt = self._build_context_prompt(video_context)
        prompt_parts.append(context_prompt)
        
        # ç¬¬å››çº§ï¼šè¾“å‡ºæ ¼å¼æç¤ºè¯ï¼ˆå›ºå®šï¼‰
        prompt_parts.append(self.OUTPUT_FORMAT_PROMPT)
        
        return "\n\n---\n\n".join(prompt_parts)
    
    def _build_context_prompt(self, video_context: Dict[str, Any]) -> str:
        """æ„å»ºä¸Šä¸‹æ–‡æç¤ºè¯ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰"""
        context_lines = ["**è§†é¢‘ä¿¡æ¯ï¼š**"]
        
        if "duration" in video_context:
            context_lines.append(f"- æ—¶é•¿: {video_context['duration']} ç§’")
        
        if "keyframe_count" in video_context:
            context_lines.append(f"- å…³é”®å¸§æ•°é‡: {video_context['keyframe_count']}")
        
        if "file_size" in video_context:
            size_mb = video_context['file_size'] / (1024 * 1024)
            context_lines.append(f"- æ–‡ä»¶å¤§å°: {size_mb:.2f} MB")
        
        return "\n".join(context_lines)
```

---

#### 3. ResponseParserï¼ˆæ–°å¢ç»„ä»¶ï¼‰

**èŒè´£**ï¼š
- è§£æ Gemini API è¿”å›çš„ JSON æ•°æ®
- éªŒè¯æ•°æ®æ ¼å¼å’Œå¿…å¡«å­—æ®µ
- å¤„ç†è§£æå¼‚å¸¸å’Œæ•°æ®æ¸…æ´—

**JSON Schema å®šä¹‰**ï¼š
```python
GEMINI_RESPONSE_SCHEMA = {
    "type": "object",
    "required": ["summary", "key_findings", "timestamp_events"],
    "properties": {
        "summary": {"type": "string", "minLength": 10},
        "key_findings": {
            "type": "array",
            "items": {
                "type": "object",
                "required": ["category", "title", "content", "confidence"],
                "properties": {
                    "category": {"type": "string"},
                    "title": {"type": "string"},
                    "content": {"type": "string"},
                    "confidence": {"type": "integer", "minimum": 0, "maximum": 100},
                    "related_timestamps": {"type": "array", "items": {"type": "number"}}
                }
            }
        },
        "timestamp_events": {
            "type": "array",
            "items": {
                "type": "object",
                "required": ["timestamp", "event_type", "title"],
                "properties": {
                    "timestamp": {"type": "number", "minimum": 0},
                    "event_type": {"type": "string", "enum": ["highlight", "scene_change", "action"]},
                    "title": {"type": "string"},
                    "description": {"type": "string"},
                    "importance_score": {"type": "integer", "minimum": 1, "maximum": 10}
                }
            }
        },
        "metadata": {"type": "object"}
    }
}
```

**è§£æå™¨å®ç°**ï¼š
```python
import json
import jsonschema
from typing import Dict, Any, Optional

class ResponseParser:
    def __init__(self, schema: Dict = GEMINI_RESPONSE_SCHEMA):
        self.schema = schema
        self.logger = get_logger("ResponseParser")
    
    def parse(self, response_text: str) -> Optional[Dict[str, Any]]:
        """è§£æ Gemini è¿”å›çš„æ–‡æœ¬ï¼Œæå– JSON æ•°æ®"""
        try:
            # å°è¯•ç›´æ¥è§£æ JSON
            data = json.loads(response_text)
        except json.JSONDecodeError:
            # å¦‚æœå¤±è´¥ï¼Œå°è¯•æå– JSON ä»£ç å—
            data = self._extract_json_from_markdown(response_text)
        
        if data is None:
            self.logger.error("Failed to extract JSON from response")
            return None
        
        # éªŒè¯ JSON Schema
        try:
            jsonschema.validate(instance=data, schema=self.schema)
            return data
        except jsonschema.ValidationError as e:
            self.logger.error(f"JSON validation failed: {e.message}")
            return None
    
    def _extract_json_from_markdown(self, text: str) -> Optional[Dict]:
        """ä» Markdown ä»£ç å—ä¸­æå– JSON"""
        import re
        # åŒ¹é… ```json ... ``` æˆ– ``` ... ```
        pattern = r'```(?:json)?\s*(\{.*?\})\s*```'
        match = re.search(pattern, text, re.DOTALL)
        if match:
            try:
                return json.loads(match.group(1))
            except json.JSONDecodeError:
                pass
        return None
```

---

#### 4. VideoPreprocessorï¼ˆæ–°å¢ç»„ä»¶ï¼‰

**èŒè´£**ï¼š
- éªŒè¯è§†é¢‘æ–‡ä»¶æ ¼å¼å’Œå¤§å°
- å‹ç¼©è§†é¢‘ä»¥æ»¡è¶³ API é™åˆ¶
- æå–è§†é¢‘å…ƒæ•°æ®ï¼ˆæ—¶é•¿ã€åˆ†è¾¨ç‡ã€å¸§ç‡ï¼‰

**å®ç°è¦ç‚¹**ï¼š
```python
class VideoPreprocessor:
    MAX_FILE_SIZE = 2 * 1024 * 1024 * 1024  # 2GB (Gemini API é™åˆ¶)
    SUPPORTED_FORMATS = ['.mp4', '.mpeg', '.mov', '.avi', '.flv', '.mpg', '.webm', '.wmv', '.3gpp']
    
    def validate_video(self, video_path: str) -> bool:
        """éªŒè¯è§†é¢‘æ–‡ä»¶"""
        import os
        if not os.path.exists(video_path):
            return False
        
        file_size = os.path.getsize(video_path)
        if file_size > self.MAX_FILE_SIZE:
            self.logger.warning(f"Video file too large: {file_size} bytes")
            return False
        
        ext = os.path.splitext(video_path)[1].lower()
        if ext not in self.SUPPORTED_FORMATS:
            self.logger.warning(f"Unsupported format: {ext}")
            return False
        
        return True
    
    def get_video_metadata(self, video_path: str) -> Dict[str, Any]:
        """æå–è§†é¢‘å…ƒæ•°æ®ï¼ˆä½¿ç”¨ OpenCV æˆ– FFmpegï¼‰"""
        # å®ç°ç•¥ï¼Œå¯ä½¿ç”¨ cv2.VideoCapture æˆ– ffprobe
        pass
```

---

## ğŸ“Š æ•°æ®æµç¨‹è®¾è®¡

### å®Œæ•´åˆ†ææµç¨‹

```mermaid
sequenceDiagram
    participant UI as QML UI
    participant VM as AnalyzerViewModel
    participant AS as AnalyzerService
    participant GS as GeminiService
    participant PB as PromptBuilder
    participant RP as ResponseParser
    participant DB as Database
    participant API as Gemini API
    
    UI->>VM: è§¦å‘åˆ†æï¼ˆå…³é”®å¸§è§†é¢‘IDï¼‰
    VM->>AS: analyze_with_gemini(keyframe_id, template_id)
    AS->>DB: è·å–å…³é”®å¸§è§†é¢‘è·¯å¾„
    AS->>DB: è·å– Prompt æ¨¡æ¿
    AS->>PB: build_prompt(template, variables, context)
    PB-->>AS: è¿”å›å®Œæ•´ Prompt
    AS->>GS: analyze_video(video_path, prompt)
    GS->>API: ä¸Šä¼ è§†é¢‘æ–‡ä»¶
    API-->>GS: è¿”å› file_uri
    GS->>API: ç­‰å¾…æ–‡ä»¶å¤„ç†å®Œæˆ
    GS->>API: å‘é€åˆ†æè¯·æ±‚ï¼ˆfile_uri + promptï¼‰
    API-->>GS: è¿”å›åˆ†æç»“æœï¼ˆJSON æ–‡æœ¬ï¼‰
    GS->>RP: parse(response_text)
    RP-->>GS: è¿”å›è§£æåçš„ JSON æ•°æ®
    GS-->>AS: è¿”å›åˆ†æç»“æœ
    AS->>DB: ä¿å­˜ AI åˆ†æç»“æœ
    AS->>DB: ä¿å­˜ Key Findings
    AS->>DB: ä¿å­˜ Timestamp Events
    AS-->>VM: è¿”å›åˆ†æå®ŒæˆçŠ¶æ€
    VM-->>UI: æ›´æ–° UI æ˜¾ç¤ºç»“æœ
```

---

## ğŸ’» å®ç°æ­¥éª¤

### é˜¶æ®µä¸€ï¼šåŸºç¡€è®¾æ–½æ­å»º

#### 1.1 åˆ›å»º GeminiService

**æ–‡ä»¶ä½ç½®**ï¼š`python/services/gemini_service.py`

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
```python
import google.generativeai as genai
from typing import Dict, Any, Optional
import time
import os

class GeminiService:
    def __init__(self, api_key: str = None, model_name: str = "gemini-2.0-flash-exp"):
        """åˆå§‹åŒ– Gemini æœåŠ¡
        
        Args:
            api_key: Google API å¯†é’¥ï¼ˆå¦‚æœä¸º Noneï¼Œä»ç¯å¢ƒå˜é‡è¯»å–ï¼‰
            model_name: ä½¿ç”¨çš„æ¨¡å‹åç§°
        """
        self.api_key = api_key or os.getenv("GOOGLE_API_KEY")
        if not self.api_key:
            raise ValueError("Google API key is required")
        
        genai.configure(api_key=self.api_key)
        self.model = genai.GenerativeModel(model_name)
        self.logger = get_logger("GeminiService")
    
    def upload_video(self, video_path: str) -> str:
        """ä¸Šä¼ è§†é¢‘åˆ° Gemini API
        
        Returns:
            str: ä¸Šä¼ åçš„ file_uri
        """
        self.logger.info(f"Uploading video: {video_path}")
        video_file = genai.upload_file(path=video_path)
        self.logger.info(f"Video uploaded: {video_file.uri}")
        return video_file.uri
    
    def wait_for_file_active(self, file_uri: str, timeout: int = 300) -> bool:
        """ç­‰å¾…æ–‡ä»¶å¤„ç†å®Œæˆ
        
        Args:
            file_uri: æ–‡ä»¶ URI
            timeout: è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
        
        Returns:
            bool: æ˜¯å¦æˆåŠŸæ¿€æ´»
        """
        start_time = time.time()
        while time.time() - start_time < timeout:
            file = genai.get_file(file_uri)
            if file.state.name == "ACTIVE":
                self.logger.info(f"File is active: {file_uri}")
                return True
            elif file.state.name == "FAILED":
                self.logger.error(f"File processing failed: {file_uri}")
                return False
            
            time.sleep(2)
        
        self.logger.error(f"File activation timeout: {file_uri}")
        return False
    
    def analyze_video(self, video_path: str, prompt: str) -> Optional[Dict[str, Any]]:
        """åˆ†æè§†é¢‘å†…å®¹
        
        Args:
            video_path: è§†é¢‘æ–‡ä»¶è·¯å¾„
            prompt: åˆ†ææç¤ºè¯
        
        Returns:
            Dict: è§£æåçš„ JSON ç»“æœï¼Œå¤±è´¥è¿”å› None
        """
        try:
            # ä¸Šä¼ è§†é¢‘
            file_uri = self.upload_video(video_path)
            
            # ç­‰å¾…æ–‡ä»¶æ¿€æ´»
            if not self.wait_for_file_active(file_uri):
                return None
            
            # å‘é€åˆ†æè¯·æ±‚
            self.logger.info("Sending analysis request to Gemini API")
            response = self.model.generate_content(
                [genai.get_file(file_uri), prompt],
                generation_config=genai.GenerationConfig(
                    temperature=0.4,
                    response_mime_type="application/json"  # å¼ºåˆ¶ JSON è¾“å‡º
                )
            )
            
            # è§£æå“åº”
            from .response_parser import ResponseParser
            parser = ResponseParser()
            result = parser.parse(response.text)
            
            if result:
                self.logger.info("Video analysis completed successfully")
            else:
                self.logger.error("Failed to parse response")
            
            return result
            
        except Exception as e:
            self.logger.error(f"Error analyzing video: {e}")
            return None
```

---

#### 1.2 åˆ›å»º PromptBuilder

**æ–‡ä»¶ä½ç½®**ï¼š`python/services/prompt_builder.py`

**å®ç°è¦ç‚¹**ï¼š
- æ”¯æŒå¤šçº§ Prompt ç»„åˆ
- é›†æˆç°æœ‰çš„ [PromptTemplateDAO](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/python/database/prompt_template_dao.py#14-117)
- æä¾›å˜é‡æ›¿æ¢åŠŸèƒ½

---

#### 1.3 åˆ›å»º ResponseParser

**æ–‡ä»¶ä½ç½®**ï¼š`python/services/response_parser.py`

**å®ç°è¦ç‚¹**ï¼š
- ä½¿ç”¨ `jsonschema` åº“è¿›è¡ŒéªŒè¯
- æ”¯æŒä» Markdown ä»£ç å—æå– JSON
- æä¾›è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

---

### é˜¶æ®µäºŒï¼šé›†æˆåˆ° AnalyzerService

#### 2.1 æ‰©å±• AnalyzerService

åœ¨ [python/services/analyzer_service.py](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/python/services/analyzer_service.py) ä¸­æ·»åŠ æ–°æ–¹æ³•ï¼š

```python
class AnalyzerService:
    def __init__(self, module_manager: ModuleManager):
        # ... ç°æœ‰ä»£ç  ...
        self._gemini_service: Optional[GeminiService] = None
        self._prompt_builder: Optional[PromptBuilder] = None
    
    def initialize_gemini(self, api_key: str) -> bool:
        """åˆå§‹åŒ– Gemini æœåŠ¡"""
        try:
            from services.gemini_service import GeminiService
            from services.prompt_builder import PromptBuilder
            
            self._gemini_service = GeminiService(api_key=api_key)
            self._prompt_builder = PromptBuilder()
            self.logger.info("Gemini service initialized")
            return True
        except Exception as e:
            self.logger.error(f"Failed to initialize Gemini: {e}")
            return False
    
    def analyze_keyframe_video_with_gemini(
        self, 
        keyframe_id: str, 
        scenario_category: str = "general",  # ç”¨æˆ·é€‰æ‹©çš„åœºæ™¯ç±»åˆ«
        custom_variables: Dict[str, str] = None
    ) -> Optional[str]:
        """ä½¿ç”¨ Gemini åˆ†æå…³é”®å¸§è§†é¢‘
        
        Args:
            keyframe_id: å…³é”®å¸§è§†é¢‘ ID
            scenario_category: åœºæ™¯ç±»åˆ«ï¼ˆç”¨æˆ·æ§åˆ¶ï¼‰
                - 'coding_algorithm': ç¼–ç¨‹å¼€å‘
                - 'meeting': ä¼šè®®è®¨è®º
                - 'teaching': æ•™å­¦è®²åº§
                - 'gaming': æ¸¸æˆå½•åˆ¶
                - 'general': é€šç”¨åˆ†æï¼ˆé»˜è®¤ï¼‰
            custom_variables: æ¨¡æ¿å˜é‡ï¼ˆå¯é€‰ï¼‰
        
        Returns:
            str: åˆ†æç»“æœ IDï¼Œå¤±è´¥è¿”å› None
        """
        if not self._gemini_service or not self._history_service:
            self.logger.error("Gemini service or history service not initialized")
            return None
        
        try:
            # 1. è·å–å…³é”®å¸§è§†é¢‘ä¿¡æ¯
            keyframe_video = self._history_service.get_keyframe_video(keyframe_id)
            if not keyframe_video:
                self.logger.error(f"Keyframe video not found: {keyframe_id}")
                return None
            
            video_path = keyframe_video.keyframe_video_path
            
            # 2. æ„å»º Promptï¼ˆä¼ å…¥ç”¨æˆ·é€‰æ‹©çš„åœºæ™¯ï¼‰
            video_context = {
                "duration": keyframe_video.duration_seconds,
                "keyframe_count": keyframe_video.keyframe_count,
                "file_size": keyframe_video.file_size_bytes
            }
            
            prompt = self._prompt_builder.build_prompt(
                scenario_category=scenario_category,  # ç”¨æˆ·æ§åˆ¶çš„å±‚çº§
                video_context=video_context,
                custom_variables=custom_variables
            )
            
            # 3. è°ƒç”¨ Gemini API
            self.logger.info(f"Analyzing video with Gemini (scenario: {scenario_category}): {video_path}")
            result = self._gemini_service.analyze_video(video_path, prompt)
            
            if not result:
                return None
            
            # 4. è·å–ä½¿ç”¨çš„æ¨¡æ¿ IDï¼ˆç”¨äºè®°å½•ï¼‰
            from database.prompt_template_dao import PromptTemplateDAO
            prompt_dao = PromptTemplateDAO(self._history_service._db)
            template = prompt_dao.get_default(category=scenario_category)
            template_id = template.prompt_id if template else ""
            
            # 5. ä¿å­˜åˆ†æç»“æœåˆ°æ•°æ®åº“
            analysis_id = self._save_gemini_analysis_result(
                keyframe_id=keyframe_id,
                prompt_id=template_id,
                scenario_category=scenario_category,  # è®°å½•ä½¿ç”¨çš„åœºæ™¯
                result=result
            )
            
            return analysis_id
            
        except Exception as e:
            self.logger.error(f"Error in Gemini analysis: {e}")
            return None
    
    def _save_gemini_analysis_result(
        self, 
        keyframe_id: str, 
        prompt_id: str,
        scenario_category: str,
        result: Dict[str, Any]
    ) -> str:
        """ä¿å­˜ Gemini åˆ†æç»“æœåˆ°æ•°æ®åº“"""
        from database.ai_analysis_dao import AIAnalysisDAO
        from database.key_finding_dao import KeyFindingDAO
        from database.timestamp_event_dao import TimestampEventDAO
        from database.models import AIAnalysis, KeyFinding, TimestampEvent
        import uuid
        from datetime import datetime
        
        db = self._history_service._db
        analysis_dao = AIAnalysisDAO(db)
        finding_dao = KeyFindingDAO(db)
        event_dao = TimestampEventDAO(db)
        
        # åˆ›å»º AI åˆ†æè®°å½•
        analysis = AIAnalysis(
            analysis_id=str(uuid.uuid4()),
            keyframe_id=keyframe_id,
            prompt_id=prompt_id,
            analysis_type=f"gemini_{scenario_category}",  # è®°å½•åœºæ™¯ç±»å‹
            model_name="gemini-2.0-flash-exp",
            model_version="2.0",
            status="completed",
            summary_md=result.get("summary", ""),
            started_at=datetime.now().isoformat(),
            completed_at=datetime.now().isoformat()
        )
        analysis_dao.create(analysis)
        
        # ä¿å­˜ Key Findings
        for idx, finding_data in enumerate(result.get("key_findings", [])):
            finding = KeyFinding(
                finding_id=str(uuid.uuid4()),
                analysis_id=analysis.analysis_id,
                sequence_order=idx,
                category=finding_data.get("category", "general"),
                title=finding_data.get("title", ""),
                content=finding_data.get("content", ""),
                related_timestamps=finding_data.get("related_timestamps", []),
                confidence_score=finding_data.get("confidence", 80)
            )
            finding_dao.create(finding)
        
        # ä¿å­˜ Timestamp Events
        for event_data in result.get("timestamp_events", []):
            event = TimestampEvent(
                event_id=str(uuid.uuid4()),
                analysis_id=analysis.analysis_id,
                timestamp_seconds=event_data.get("timestamp", 0.0),
                event_type=event_data.get("event_type", "highlight"),
                title=event_data.get("title", ""),
                description=event_data.get("description", ""),
                importance_score=event_data.get("importance_score", 5)
            )
            event_dao.create(event)
        
        self.logger.info(f"Saved Gemini analysis result: {analysis.analysis_id}")
        return analysis.analysis_id
```

---

### é˜¶æ®µä¸‰ï¼šUI é›†æˆ

#### 3.1 æ‰©å±• AnalyzerViewModel

åœ¨ [python/viewmodels/analyzer_viewmodel.py](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/python/viewmodels/analyzer_viewmodel.py) ä¸­æ·»åŠ ï¼š

```python
from PySide6.QtCore import Slot, Signal

@Slot(str, str, result=bool)
def analyzeWithGemini(self, keyframe_id: str, scenario_category: str = "general") -> bool:
    """ä½¿ç”¨ Gemini åˆ†æå…³é”®å¸§è§†é¢‘ï¼ˆQML è°ƒç”¨ï¼‰
    
    Args:
        keyframe_id: å…³é”®å¸§è§†é¢‘ ID
        scenario_category: ç”¨æˆ·é€‰æ‹©çš„åœºæ™¯ç±»åˆ«
            - "coding_algorithm": ç¼–ç¨‹å¼€å‘
            - "meeting": ä¼šè®®è®¨è®º
            - "teaching": æ•™å­¦è®²åº§
            - "gaming": æ¸¸æˆå½•åˆ¶
            - "general": é€šç”¨åˆ†æ
    
    Returns:
        bool: æˆåŠŸå¯åŠ¨åˆ†æè¿”å› True
    """
    if not self._service:
        self.analysisError.emit("åˆ†ææœåŠ¡æœªåˆå§‹åŒ–")
        return False
    
    # å¼‚æ­¥æ‰§è¡Œåˆ†æï¼ˆé¿å…é˜»å¡ UIï¼‰
    import threading
    
    def run_analysis():
        analysis_id = self._service.analyze_keyframe_video_with_gemini(
            keyframe_id=keyframe_id,
            scenario_category=scenario_category
        )
        
        if analysis_id:
            self.analysisCompleted.emit(analysis_id)
        else:
            self.analysisError.emit("Gemini åˆ†æå¤±è´¥")
    
    thread = threading.Thread(target=run_analysis, daemon=True)
    thread.start()
    return True

# æ·»åŠ ä¿¡å·
analysisCompleted = Signal(str)  # åˆ†æå®Œæˆä¿¡å·ï¼Œä¼ é€’ analysis_id
analysisError = Signal(str)  # åˆ†æé”™è¯¯ä¿¡å·
analysisProgress = Signal(int)  # åˆ†æè¿›åº¦ä¿¡å·ï¼ˆ0-100ï¼‰

# æ·»åŠ å±æ€§ï¼šè·å–å¯ç”¨åœºæ™¯åˆ—è¡¨
@Property(list, constant=True)
def availableScenarios(self) -> list:
    """è¿”å›å¯ç”¨çš„åœºæ™¯åˆ—è¡¨ï¼ˆä¾› QML ä½¿ç”¨ï¼‰"""
    return [
        {"id": "general", "name": "é€šç”¨åˆ†æ", "icon": "ğŸ“Š", "description": "é€‚ç”¨äºå„ç±»è§†é¢‘çš„é€šç”¨åˆ†æ"},
        {"id": "coding_algorithm", "name": "ç¼–ç¨‹å¼€å‘", "icon": "ğŸ’»", "description": "ä»£ç ç¼–å†™ã€ç®—æ³•è®²è§£ã€è°ƒè¯•è¿‡ç¨‹"},
        {"id": "meeting", "name": "ä¼šè®®è®¨è®º", "icon": "ğŸ‘¥", "description": "å›¢é˜Ÿä¼šè®®ã€å¤´è„‘é£æš´ã€é¡¹ç›®è¯„å®¡"},
        {"id": "teaching", "name": "æ•™å­¦è®²åº§", "icon": "ğŸ“", "description": "è¯¾ç¨‹è®²è§£ã€çŸ¥è¯†åˆ†äº«ã€åŸ¹è®­"},
        {"id": "gaming", "name": "æ¸¸æˆå½•åˆ¶", "icon": "ğŸ®", "description": "æ¸¸æˆå®å†µã€æ”»ç•¥æ¼”ç¤ºã€ç«æŠ€æ¯”èµ›"}
    ]
```

---

#### 3.2 QML UI é›†æˆç¤ºä¾‹

**åœºæ™¯é€‰æ‹©å™¨ç»„ä»¶**ï¼š

```qml
// ScenarioSelector.qml
import QtQuick
import QtQuick.Controls
import QtQuick.Layouts

Rectangle {
    id: root
    width: 600
    height: 400
    color: "#1E1E1E"
    
    property string selectedScenario: "general"
    
    signal scenarioSelected(string scenarioId)
    
    ColumnLayout {
        anchors.fill: parent
        anchors.margins: 20
        spacing: 15
        
        // æ ‡é¢˜
        Text {
            text: "é€‰æ‹©åˆ†æåœºæ™¯"
            font.pixelSize: 24
            font.bold: true
            color: "#FFFFFF"
        }
        
        Text {
            text: "æ ¹æ®è§†é¢‘å†…å®¹é€‰æ‹©åˆé€‚çš„åˆ†æåœºæ™¯ï¼ŒAI å°†é’ˆå¯¹æ€§åœ°æå–å…³é”®ä¿¡æ¯"
            font.pixelSize: 14
            color: "#AAAAAA"
            wrapMode: Text.WordWrap
            Layout.fillWidth: true
        }
        
        // åœºæ™¯ç½‘æ ¼
        GridView {
            id: scenarioGrid
            Layout.fillWidth: true
            Layout.fillHeight: true
            cellWidth: width / 2
            cellHeight: 120
            clip: true
            
            model: analyzerViewModel.availableScenarios
            
            delegate: Rectangle {
                width: scenarioGrid.cellWidth - 10
                height: scenarioGrid.cellHeight - 10
                color: root.selectedScenario === modelData.id ? "#3498DB" : "#2C2C2C"
                radius: 8
                border.color: mouseArea.containsMouse ? "#5DADE2" : "transparent"
                border.width: 2
                
                Behavior on color { ColorAnimation { duration: 200 } }
                
                ColumnLayout {
                    anchors.fill: parent
                    anchors.margins: 15
                    spacing: 8
                    
                    // å›¾æ ‡
                    Text {
                        text: modelData.icon
                        font.pixelSize: 32
                        Layout.alignment: Qt.AlignHCenter
                    }
                    
                    // åç§°
                    Text {
                        text: modelData.name
                        font.pixelSize: 16
                        font.bold: true
                        color: "#FFFFFF"
                        Layout.alignment: Qt.AlignHCenter
                    }
                    
                    // æè¿°
                    Text {
                        text: modelData.description
                        font.pixelSize: 12
                        color: "#CCCCCC"
                        wrapMode: Text.WordWrap
                        horizontalAlignment: Text.AlignHCenter
                        Layout.fillWidth: true
                    }
                }
                
                MouseArea {
                    id: mouseArea
                    anchors.fill: parent
                    hoverEnabled: true
                    cursorShape: Qt.PointingHandCursor
                    
                    onClicked: {
                        root.selectedScenario = modelData.id
                        root.scenarioSelected(modelData.id)
                    }
                }
            }
        }
        
        // ç¡®è®¤æŒ‰é’®
        Button {
            text: "å¼€å§‹ AI åˆ†æ"
            Layout.alignment: Qt.AlignHCenter
            Layout.preferredWidth: 200
            Layout.preferredHeight: 45
            
            background: Rectangle {
                color: parent.hovered ? "#2980B9" : "#3498DB"
                radius: 6
                
                Behavior on color { ColorAnimation { duration: 150 } }
            }
            
            contentItem: Text {
                text: parent.text
                font.pixelSize: 16
                font.bold: true
                color: "#FFFFFF"
                horizontalAlignment: Text.AlignHCenter
                verticalAlignment: Text.AlignVCenter
            }
            
            onClicked: {
                // è°ƒç”¨ ViewModel æ–¹æ³•
                analyzerViewModel.analyzeWithGemini(keyframeId, root.selectedScenario)
                // å…³é—­å¯¹è¯æ¡†æˆ–æ˜¾ç¤ºè¿›åº¦
            }
        }
    }
}
```

**åœ¨ä¸»é¡µé¢ä¸­ä½¿ç”¨**ï¼š

```qml
// AnalysisPage.qml
import QtQuick
import QtQuick.Controls
import QtQuick.Dialogs

Page {
    id: analysisPage
    
    property string currentKeyframeId: ""
    
    // åœºæ™¯é€‰æ‹©å¯¹è¯æ¡†
    Dialog {
        id: scenarioDialog
        title: "é€‰æ‹©åˆ†æåœºæ™¯"
        width: 650
        height: 500
        modal: true
        
        ScenarioSelector {
            id: scenarioSelector
            anchors.fill: parent
            
            onScenarioSelected: function(scenarioId) {
                console.log("Selected scenario:", scenarioId)
                scenarioDialog.close()
            }
        }
    }
    
    // åˆ†ææŒ‰é’®
    Button {
        text: "AI æ™ºèƒ½åˆ†æ"
        onClicked: {
            if (currentKeyframeId) {
                scenarioDialog.open()
            }
        }
    }
    
    // ç›‘å¬åˆ†æå®Œæˆä¿¡å·
    Connections {
        target: analyzerViewModel
        
        function onAnalysisCompleted(analysisId) {
            console.log("Analysis completed:", analysisId)
            // æ˜¾ç¤ºåˆ†æç»“æœ
            showAnalysisResult(analysisId)
        }
        
        function onAnalysisError(errorMsg) {
            console.error("Analysis error:", errorMsg)
            // æ˜¾ç¤ºé”™è¯¯æç¤º
            errorDialog.text = errorMsg
            errorDialog.open()
        }
    }
}
```

---

## ğŸ”§ é…ç½®ç®¡ç†

### é…ç½®æ–‡ä»¶è®¾è®¡

**æ–‡ä»¶ä½ç½®**ï¼š`configs/gemini_config.json`

```json
{
  "api_key": "${GOOGLE_API_KEY}",
  "model_name": "gemini-2.0-flash-exp",
  "generation_config": {
    "temperature": 0.4,
    "top_p": 0.95,
    "top_k": 40,
    "max_output_tokens": 8192,
    "response_mime_type": "application/json"
  },
  "upload_config": {
    "max_file_size_mb": 2048,
    "timeout_seconds": 300,
    "retry_attempts": 3
  },
  "prompt_config": {
    "default_template_id": "",
    "enable_multi_level": true,
    "include_video_metadata": true
  }
}
```

---

## ğŸ“ Prompt æ¨¡æ¿ç¤ºä¾‹ï¼ˆç”¨æˆ·å¯æ§åœºæ™¯ï¼‰

### åœºæ™¯ä¸€ï¼šç¼–ç¨‹å¼€å‘åˆ†æ

```sql
INSERT INTO prompt_template (
    prompt_id, name, description, prompt_content, category, is_default, 
    created_at, updated_at, tags, variables
) VALUES (
    'task-coding-algorithm-v1',
    'ç¼–ç¨‹ç®—æ³•åˆ†ææ¨¡æ¿',
    'ç”¨äºåˆ†æç¼–ç¨‹ã€ç®—æ³•è®²è§£ã€ä»£ç è°ƒè¯•ç±»è§†é¢‘',
    'è¿™æ˜¯ä¸€ä¸ªç¼–ç¨‹ç®—æ³•ç›¸å…³çš„è§†é¢‘ã€‚è¯·ä½œä¸ºä¸€ä¸ªèµ„æ·±ç¨‹åºå‘˜ï¼Œé‡ç‚¹åˆ†æï¼š

**ä»£ç åˆ†æï¼š**
1. ç®—æ³•çš„æ ¸å¿ƒæ€æƒ³å’Œå®ç°é€»è¾‘
2. ä»£ç çš„å…³é”®æ­¥éª¤å’Œæ—¶é—´å¤æ‚åº¦åˆ†æ
3. æ•°æ®ç»“æ„çš„é€‰æ‹©å’Œä½¿ç”¨
4. ä»£ç ä¼˜åŒ–æŠ€å·§å’Œæœ€ä½³å®è·µ

**è°ƒè¯•è¿‡ç¨‹ï¼š**
1. å‡ºç°çš„é”™è¯¯ç±»å‹å’Œé”™è¯¯ä¿¡æ¯
2. è°ƒè¯•æ–¹æ³•å’Œé—®é¢˜å®šä½è¿‡ç¨‹
3. è§£å†³æ–¹æ¡ˆå’Œä¿®å¤æ­¥éª¤

**å…³é”®æ—¶åˆ»è¯†åˆ«ï¼š**
- ä»£ç ç¼–è¾‘å™¨ä¸­çš„é‡è¦ä»£ç ç‰‡æ®µ
- ç»ˆç«¯è¾“å‡ºçš„å…³é”®ä¿¡æ¯
- ç®—æ³•å›¾è§£å’Œæ•°æ®ç»“æ„å¯è§†åŒ–
- æ€§èƒ½æµ‹è¯•å’Œç»“æœå¯¹æ¯”

è¯·ç‰¹åˆ«å…³æ³¨ä»£ç ä¸­çš„å‡½æ•°å®šä¹‰ã€ç±»å£°æ˜ã€å¾ªç¯ç»“æ„ã€æ¡ä»¶åˆ¤æ–­ç­‰å…³é”®è¯­æ³•ç»“æ„ã€‚',
    'coding_algorithm',
    1,
    datetime('now'),
    datetime('now'),
    '["ç¼–ç¨‹", "ç®—æ³•", "ä»£ç ", "è°ƒè¯•"]',
    '[]'
);
```

### åœºæ™¯äºŒï¼šä¼šè®®è®¨è®ºåˆ†æ

```sql
INSERT INTO prompt_template (
    prompt_id, name, description, prompt_content, category, is_default, 
    created_at, updated_at, tags, variables
) VALUES (
    'task-meeting-summary-v1',
    'ä¼šè®®å†…å®¹åˆ†ææ¨¡æ¿',
    'ç”¨äºåˆ†æå›¢é˜Ÿä¼šè®®ã€é¡¹ç›®è¯„å®¡ã€å¤´è„‘é£æš´ç±»è§†é¢‘',
    'è¿™æ˜¯ä¸€ä¸ªä¼šè®®å½•åˆ¶è§†é¢‘ã€‚è¯·ä½œä¸ºä¸€ä¸ªä¼šè®®è®°å½•å‘˜ï¼Œé‡ç‚¹åˆ†æï¼š

**ä¼šè®®å†…å®¹ï¼š**
1. ä¼šè®®çš„ä¸»è¦è®®é¢˜å’Œè®¨è®ºç›®æ ‡
2. å‚ä¸è€…çš„å‘è¨€è¦ç‚¹å’Œæ ¸å¿ƒè§‚ç‚¹
3. è®¨è®ºä¸­çš„äº‰è®®ç‚¹å’Œä¸åŒæ„è§
4. è¾¾æˆçš„å…±è¯†å’Œå†³ç­–ç»“æœ

**è¡ŒåŠ¨é¡¹è¯†åˆ«ï¼š**
1. æ˜ç¡®çš„ä»»åŠ¡åˆ†é…å’Œè´£ä»»äºº
2. æ—¶é—´èŠ‚ç‚¹å’Œæˆªæ­¢æ—¥æœŸ
3. éœ€è¦è·Ÿè¿›çš„äº‹é¡¹

**å…³é”®æ—¶åˆ»è¯†åˆ«ï¼š**
- å‘è¨€äººåˆ‡æ¢å’Œé‡è¦å‘è¨€
- PPT æ¼”ç¤ºæ–‡ç¨¿çš„ç¿»é¡µå’Œå…³é”®é¡µé¢
- ç™½æ¿ä¹¦å†™å’Œå›¾è¡¨å±•ç¤º
- æŠ•ç¥¨è¡¨å†³å’Œå†³ç­–æ—¶åˆ»
- é‡è¦æ•°æ®å’Œå›¾è¡¨çš„å±•ç¤º

è¯·è¯†åˆ«ä¼šè®®ä¸­çš„å…³é”®å†³ç­–ç‚¹ï¼Œå¹¶æ ‡æ³¨æ¯ä¸ªè®®é¢˜çš„è®¨è®ºæ—¶é—´æ®µã€‚',
    'meeting',
    1,
    datetime('now'),
    datetime('now'),
    '["ä¼šè®®", "è®¨è®º", "åä½œ", "å†³ç­–"]',
    '[]'
);
```

### åœºæ™¯ä¸‰ï¼šæ•™å­¦è®²åº§åˆ†æ

```sql
INSERT INTO prompt_template (
    prompt_id, name, description, prompt_content, category, is_default, 
    created_at, updated_at, tags, variables
) VALUES (
    'task-teaching-lecture-v1',
    'æ•™å­¦è®²åº§åˆ†ææ¨¡æ¿',
    'ç”¨äºåˆ†æè¯¾ç¨‹è®²è§£ã€çŸ¥è¯†åˆ†äº«ã€åŸ¹è®­ç±»è§†é¢‘',
    'è¿™æ˜¯ä¸€ä¸ªæ•™å­¦è®²åº§è§†é¢‘ã€‚è¯·ä½œä¸ºä¸€ä¸ªæ•™å­¦åŠ©æ‰‹ï¼Œé‡ç‚¹åˆ†æï¼š

**çŸ¥è¯†ç»“æ„ï¼š**
1. è¯¾ç¨‹çš„ä¸»é¢˜å’Œå­¦ä¹ ç›®æ ‡
2. çŸ¥è¯†ç‚¹çš„è®²è§£é¡ºåºå’Œé€»è¾‘ç»“æ„
3. é‡è¦æ¦‚å¿µçš„å®šä¹‰å’Œè§£é‡Š
4. ç†è®ºä¸å®è·µçš„ç»“åˆæ–¹å¼

**æ•™å­¦æ–¹æ³•ï¼š**
1. ä½¿ç”¨çš„æ•™å­¦æ‰‹æ®µï¼ˆæ¼”ç¤ºã€å®éªŒã€æ¡ˆä¾‹åˆ†æï¼‰
2. äº’åŠ¨ç¯èŠ‚ï¼ˆæé—®ã€ç­”ç–‘ã€è®¨è®ºï¼‰
3. é‡ç‚¹å’Œéš¾ç‚¹çš„å¼ºè°ƒæ–¹å¼
4. çŸ¥è¯†ç‚¹çš„æ€»ç»“å’Œå›é¡¾

**å…³é”®æ—¶åˆ»è¯†åˆ«ï¼š**
- æ–°æ¦‚å¿µçš„å¼•å…¥å’Œå®šä¹‰
- æ¿ä¹¦å’Œè¯¾ä»¶çš„å…³é”®å†…å®¹
- æ¼”ç¤ºå®éªŒå’Œæ“ä½œæ­¥éª¤
- ä¾‹é¢˜è®²è§£å’Œè§£é¢˜è¿‡ç¨‹
- å­¦ç”Ÿæé—®å’Œæ•™å¸ˆç­”ç–‘
- ç« èŠ‚æ€»ç»“å’ŒçŸ¥è¯†å›é¡¾

è¯·ä¸ºæ¯ä¸ªçŸ¥è¯†ç‚¹æ ‡æ³¨æ—¶é—´æˆ³ï¼Œä¾¿äºå­¦ç”Ÿå¿«é€Ÿå®šä½å’Œå¤ä¹ ã€‚',
    'teaching',
    1,
    datetime('now'),
    datetime('now'),
    '["æ•™å­¦", "è®²åº§", "è¯¾ç¨‹", "åŸ¹è®­"]',
    '[]'
);
```

### åœºæ™¯å››ï¼šæ¸¸æˆå½•åˆ¶åˆ†æ

```sql
INSERT INTO prompt_template (
    prompt_id, name, description, prompt_content, category, is_default, 
    created_at, updated_at, tags, variables
) VALUES (
    'task-gaming-highlight-v1',
    'æ¸¸æˆå½•åˆ¶åˆ†ææ¨¡æ¿',
    'ç”¨äºåˆ†ææ¸¸æˆå®å†µã€æ”»ç•¥æ¼”ç¤ºã€ç«æŠ€æ¯”èµ›ç±»è§†é¢‘',
    'è¿™æ˜¯ä¸€ä¸ªæ¸¸æˆå½•åˆ¶è§†é¢‘ã€‚è¯·ä½œä¸ºä¸€ä¸ªæ¸¸æˆè§£è¯´å‘˜ï¼Œé‡ç‚¹åˆ†æï¼š

**æ¸¸æˆå†…å®¹ï¼š**
1. æ¸¸æˆçš„ç±»å‹å’Œç©æ³•æœºåˆ¶
2. å½“å‰å…³å¡æˆ–åœºæ™¯çš„ç›®æ ‡
3. ç©å®¶çš„ç­–ç•¥å’Œæ“ä½œæŠ€å·§
4. æ¸¸æˆè¿›åº¦å’Œæˆå°±è§£é”

**ç²¾å½©æ—¶åˆ»ï¼š**
1. é«˜å…‰æ“ä½œå’Œç²¾å½©å‡»æ€
2. å…³é”®å†³ç­–å’Œæˆ˜æœ¯é€‰æ‹©
3. å¤±è¯¯å’Œç¿»ç›˜æ—¶åˆ»
4. ç¨€æœ‰ç‰©å“è·å–å’Œæˆå°±è¾¾æˆ

**å…³é”®æ—¶åˆ»è¯†åˆ«ï¼š**
- æˆ˜æ–—å¼€å§‹å’Œç»“æŸ
- Boss æˆ˜å’Œå…³é”®å¯¹å†³
- æŠ€èƒ½é‡Šæ”¾å’Œè¿æ‹›æ“ä½œ
- ä»»åŠ¡å®Œæˆå’Œå¥–åŠ±è·å–
- å‰§æƒ…è¿‡åœºå’Œé‡è¦å¯¹è¯
- æ¸¸æˆç»“ç®—å’Œæ•°æ®ç»Ÿè®¡

è¯·è¯†åˆ«æ¸¸æˆä¸­çš„é«˜å…‰æ—¶åˆ»ï¼Œå¹¶è¯„ä¼°æ“ä½œçš„éš¾åº¦å’Œè§‚èµæ€§ã€‚',
    'gaming',
    1,
    datetime('now'),
    datetime('now'),
    '["æ¸¸æˆ", "å®å†µ", "æ”»ç•¥", "ç«æŠ€"]',
    '[]'
);
```

### åœºæ™¯äº”ï¼šé€šç”¨åˆ†æï¼ˆé»˜è®¤ï¼‰

```sql
INSERT INTO prompt_template (
    prompt_id, name, description, prompt_content, category, is_default, 
    created_at, updated_at, tags, variables
) VALUES (
    'task-general-analysis-v1',
    'é€šç”¨è§†é¢‘åˆ†ææ¨¡æ¿',
    'é€‚ç”¨äºå„ç±»è§†é¢‘çš„é€šç”¨åˆ†ææ¨¡æ¿',
    'è¯·è¯¦ç»†åˆ†æè¿™ä¸ªè§†é¢‘çš„å†…å®¹ï¼Œé‡ç‚¹å…³æ³¨ä»¥ä¸‹æ–¹é¢ï¼š

**å†…å®¹åˆ†æï¼š**
1. è§†é¢‘çš„ä¸»è¦ä¸»é¢˜å’Œæ ¸å¿ƒå†…å®¹
2. å…³é”®åœºæ™¯å’Œé‡è¦æ—¶åˆ»
3. è§†è§‰å…ƒç´ ï¼ˆé¢œè‰²ã€æ„å›¾ã€è¿åŠ¨ã€ç‰¹æ•ˆï¼‰
4. éŸ³é¢‘å…ƒç´ ï¼ˆå¯¹è¯ã€éŸ³ä¹ã€éŸ³æ•ˆã€èƒŒæ™¯å£°ï¼‰

**ç»“æ„åˆ†æï¼š**
1. è§†é¢‘çš„æ•´ä½“ç»“æ„å’Œå™äº‹é€»è¾‘
2. åœºæ™¯è½¬æ¢å’ŒèŠ‚å¥å˜åŒ–
3. é«˜æ½®éƒ¨åˆ†å’Œæƒ…æ„Ÿèµ·ä¼

**å…³é”®æ—¶åˆ»è¯†åˆ«ï¼š**
- åœºæ™¯åˆ‡æ¢å’Œé•œå¤´å˜åŒ–
- é‡è¦å¯¹è¯å’Œä¿¡æ¯å±•ç¤º
- åŠ¨ä½œé«˜æ½®å’Œæƒ…æ„Ÿè½¬æŠ˜
- æ–‡å­—è¯´æ˜å’Œå›¾è¡¨å±•ç¤º

è¯·æå–è§†é¢‘ä¸­æœ€æœ‰ä»·å€¼çš„ä¿¡æ¯ï¼Œå¹¶æŒ‰æ—¶é—´é¡ºåºæ•´ç†å…³é”®äº‹ä»¶ã€‚',
    'general',
    1,
    datetime('now'),
    datetime('now'),
    '["é€šç”¨", "åˆ†æ", "è§†é¢‘"]',
    '[]'
);
```

### æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

å°†ä»¥ä¸Šæ‰€æœ‰åœºæ™¯æ¨¡æ¿ä¸€æ¬¡æ€§å¯¼å…¥æ•°æ®åº“ï¼š

```sql
-- åˆå§‹åŒ–æ‰€æœ‰åœºæ™¯çš„ Prompt æ¨¡æ¿
-- æ‰§è¡Œæ­¤è„šæœ¬å°†åˆ›å»º 5 ä¸ªé¢„è®¾åœºæ™¯æ¨¡æ¿

-- 1. ç¼–ç¨‹å¼€å‘
INSERT INTO prompt_template (...) VALUES (...);  -- coding_algorithm

-- 2. ä¼šè®®è®¨è®º
INSERT INTO prompt_template (...) VALUES (...);  -- meeting

-- 3. æ•™å­¦è®²åº§
INSERT INTO prompt_template (...) VALUES (...);  -- teaching

-- 4. æ¸¸æˆå½•åˆ¶
INSERT INTO prompt_template (...) VALUES (...);  -- gaming

-- 5. é€šç”¨åˆ†æ
INSERT INTO prompt_template (...) VALUES (...);  -- general
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å¼‚æ­¥å¤„ç†

```python
import asyncio
from concurrent.futures import ThreadPoolExecutor

class GeminiService:
    def __init__(self, ...):
        self.executor = ThreadPoolExecutor(max_workers=3)
    
    async def analyze_video_async(self, video_path: str, prompt: str) -> Optional[Dict]:
        """å¼‚æ­¥åˆ†æè§†é¢‘"""
        loop = asyncio.get_event_loop()
        return await loop.run_in_executor(
            self.executor, 
            self.analyze_video, 
            video_path, 
            prompt
        )
```

### 2. æ‰¹é‡å¤„ç†

å¯¹äºå¤šä¸ªå…³é”®å¸§è§†é¢‘ï¼Œå¯ä»¥å®ç°æ‰¹é‡åˆ†æï¼š

```python
def analyze_batch(self, keyframe_ids: List[str], template_id: str) -> List[str]:
    """æ‰¹é‡åˆ†æå¤šä¸ªå…³é”®å¸§è§†é¢‘"""
    results = []
    for keyframe_id in keyframe_ids:
        analysis_id = self.analyze_keyframe_video_with_gemini(keyframe_id, template_id)
        if analysis_id:
            results.append(analysis_id)
    return results
```

### 3. ç¼“å­˜æœºåˆ¶

```python
from functools import lru_cache

class PromptBuilder:
    @lru_cache(maxsize=128)
    def build_prompt(self, template_id: str, ...) -> str:
        # ç¼“å­˜å·²æ„å»ºçš„ Prompt
        pass
```

---

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†ä¸é‡è¯•ç­–ç•¥

### é”™è¯¯åˆ†ç±»

| é”™è¯¯ç±»å‹ | å¤„ç†ç­–ç•¥ | é‡è¯•æ¬¡æ•° |
|---------|---------|---------|
| ç½‘ç»œè¶…æ—¶ | æŒ‡æ•°é€€é¿é‡è¯• | 3 æ¬¡ |
| API é™æµ | ç­‰å¾…åé‡è¯• | 5 æ¬¡ |
| æ–‡ä»¶æ ¼å¼é”™è¯¯ | ç«‹å³å¤±è´¥ï¼Œè®°å½•æ—¥å¿— | 0 æ¬¡ |
| JSON è§£æå¤±è´¥ | å°è¯•æå–ï¼Œå¤±è´¥åˆ™è®°å½•åŸå§‹å“åº” | 1 æ¬¡ |
| è®¤è¯å¤±è´¥ | ç«‹å³å¤±è´¥ï¼Œæç¤ºç”¨æˆ·æ£€æŸ¥ API Key | 0 æ¬¡ |

### å®ç°ç¤ºä¾‹

```python
import time
from functools import wraps

def retry_with_backoff(max_retries=3, base_delay=1.0):
    """æŒ‡æ•°é€€é¿é‡è¯•è£…é¥°å™¨"""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            for attempt in range(max_retries):
                try:
                    return func(*args, **kwargs)
                except Exception as e:
                    if attempt == max_retries - 1:
                        raise
                    delay = base_delay * (2 ** attempt)
                    time.sleep(delay)
            return None
        return wrapper
    return decorator

class GeminiService:
    @retry_with_backoff(max_retries=3, base_delay=2.0)
    def upload_video(self, video_path: str) -> str:
        # å®ç°ä¸Šä¼ é€»è¾‘
        pass
```

---

## ğŸ“Š æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

**æ–‡ä»¶ä½ç½®**ï¼š`tests/python/test_gemini_service.py`

```python
import pytest
from unittest.mock import Mock, patch
from python.services.gemini_service import GeminiService

class TestGeminiService:
    @pytest.fixture
    def gemini_service(self):
        return GeminiService(api_key="test_key")
    
    def test_upload_video_success(self, gemini_service):
        with patch('google.generativeai.upload_file') as mock_upload:
            mock_upload.return_value = Mock(uri="test_uri")
            uri = gemini_service.upload_video("test.mp4")
            assert uri == "test_uri"
    
    def test_parse_json_response(self):
        from python.services.response_parser import ResponseParser
        parser = ResponseParser()
        
        response_text = '''```json
        {
          "summary": "Test summary",
          "key_findings": [],
          "timestamp_events": []
        }
        ```'''
        
        result = parser.parse(response_text)
        assert result is not None
        assert result["summary"] == "Test summary"
```

### é›†æˆæµ‹è¯•

æµ‹è¯•å®Œæ•´çš„åˆ†ææµç¨‹ï¼š

```python
def test_full_analysis_workflow():
    # 1. åˆ›å»ºæµ‹è¯•å…³é”®å¸§è§†é¢‘
    # 2. è°ƒç”¨ analyze_keyframe_video_with_gemini
    # 3. éªŒè¯æ•°æ®åº“ä¸­çš„ç»“æœ
    pass
```

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# .env æ–‡ä»¶
GOOGLE_API_KEY=your_api_key_here
GEMINI_MODEL_NAME=gemini-2.0-flash-exp
```

### ä¾èµ–å®‰è£…

```bash
pip install google-generativeai jsonschema
```

### æ•°æ®åº“è¿ç§»

å¦‚æœéœ€è¦æ‰©å±•ç°æœ‰è¡¨ç»“æ„ï¼Œå¯ä»¥æ·»åŠ è¿ç§»è„šæœ¬ï¼š

```sql
-- æ·»åŠ  Gemini ç›¸å…³å­—æ®µåˆ° ai_analysis è¡¨
ALTER TABLE ai_analysis ADD COLUMN gemini_file_uri TEXT;
ALTER TABLE ai_analysis ADD COLUMN gemini_request_id TEXT;
```

---

## ğŸ“ˆ ç›‘æ§ä¸æ—¥å¿—

### å…³é”®æŒ‡æ ‡

- **API è°ƒç”¨æ¬¡æ•°**ï¼šæ¯æ—¥/æ¯å°æ—¶è°ƒç”¨é‡
- **æˆåŠŸç‡**ï¼šæˆåŠŸåˆ†æçš„æ¯”ä¾‹
- **å¹³å‡å“åº”æ—¶é—´**ï¼šä»ä¸Šä¼ åˆ°è¿”å›ç»“æœçš„æ—¶é—´
- **é”™è¯¯ç‡**ï¼šå„ç±»é”™è¯¯çš„å‘ç”Ÿé¢‘ç‡

### æ—¥å¿—è®°å½•

```python
self.logger.info(f"[Gemini] Uploading video: {video_path}, size: {file_size} bytes")
self.logger.info(f"[Gemini] Analysis completed in {elapsed_time:.2f}s")
self.logger.error(f"[Gemini] API error: {error_code} - {error_message}")
```

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. Prompt å·¥ç¨‹

- âœ… **æ˜ç¡®è¾“å‡ºæ ¼å¼**ï¼šåœ¨ Prompt ä¸­æ¸…æ™°å®šä¹‰ JSON Schema
- âœ… **æä¾›ç¤ºä¾‹**ï¼šåœ¨ Prompt ä¸­åŒ…å«è¾“å‡ºç¤ºä¾‹
- âœ… **åˆ†æ­¥å¼•å¯¼**ï¼šä½¿ç”¨ç¼–å·åˆ—è¡¨å¼•å¯¼ AI æ€è€ƒè¿‡ç¨‹
- âœ… **çº¦æŸè¾“å‡ºé•¿åº¦**ï¼šé¿å…è¶…å‡º token é™åˆ¶

### 2. æ•°æ®éªŒè¯

- âœ… **å¤šå±‚éªŒè¯**ï¼šJSON æ ¼å¼ â†’ Schema éªŒè¯ â†’ ä¸šåŠ¡é€»è¾‘éªŒè¯
- âœ… **å®¹é”™å¤„ç†**ï¼šå¯¹äºéå…³é”®å­—æ®µï¼Œæä¾›é»˜è®¤å€¼
- âœ… **è®°å½•åŸå§‹å“åº”**ï¼šä¿å­˜ AI åŸå§‹è¾“å‡ºä»¥ä¾¿è°ƒè¯•

### 3. æˆæœ¬æ§åˆ¶

- âœ… **è§†é¢‘å‹ç¼©**ï¼šåœ¨ä¸å½±å“åˆ†æè´¨é‡çš„å‰æä¸‹å‹ç¼©è§†é¢‘
- âœ… **ç¼“å­˜ç»“æœ**ï¼šé¿å…é‡å¤åˆ†æç›¸åŒå†…å®¹
- âœ… **æŒ‰éœ€åˆ†æ**ï¼šåªåœ¨ç”¨æˆ·æ˜ç¡®è¯·æ±‚æ—¶è°ƒç”¨ API

---

## ğŸ”® æœªæ¥æ‰©å±•æ–¹å‘

### 1. å¤šæ¨¡æ€åˆ†æ

- ç»“åˆéŸ³é¢‘è½¬å½•ï¼ˆGemini æ”¯æŒéŸ³é¢‘åˆ†æï¼‰
- æå–è§†é¢‘ä¸­çš„æ–‡æœ¬ï¼ˆOCRï¼‰
- è¯†åˆ«äººç‰©å’Œç‰©ä½“

### 2. å®æ—¶åˆ†æ

- å¯¹æ­£åœ¨å½•åˆ¶çš„è§†é¢‘è¿›è¡Œå®æ—¶åˆ†æ
- æµå¼å¤„ç†å…³é”®å¸§

### 3. è‡ªå®šä¹‰æ¨¡å‹å¾®è°ƒ

- ä½¿ç”¨ Gemini Fine-tuning API è®­ç»ƒä¸“ç”¨æ¨¡å‹
- é’ˆå¯¹ç‰¹å®šé¢†åŸŸï¼ˆå¦‚æ•™è‚²ã€æ¸¸æˆï¼‰ä¼˜åŒ–

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Google Gemini API å®˜æ–¹æ–‡æ¡£](https://ai.google.dev/docs)
- [Gemini Python SDK](https://github.com/google/generative-ai-python)
- [JSON Schema è§„èŒƒ](https://json-schema.org/)
- [è§†é¢‘åˆ†ææœ€ä½³å®è·µ](https://ai.google.dev/gemini-api/docs/vision)

---

## âœ… æ€»ç»“

æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æäº†å¦‚ä½•åœ¨ç°æœ‰è§†é¢‘åˆ†æç³»ç»Ÿä¸­é›†æˆ Google Gemini APIï¼Œå®ç°ï¼š

1. **å¤šçº§ Prompt æ¡†æ¶**ï¼šé€šè¿‡ `PromptBuilder` å®ç°ç³»ç»Ÿæç¤ºè¯ã€ä»»åŠ¡æç¤ºè¯ã€ä¸Šä¸‹æ–‡æç¤ºè¯å’Œè¾“å‡ºæ ¼å¼çº¦æŸçš„å››çº§ç»“æ„
2. **AI JSON è¾“å‡ºæ ¼å¼çº¦å®š**ï¼šå®šä¹‰æ ‡å‡† JSON Schemaï¼Œä½¿ç”¨ `response_mime_type="application/json"` å¼ºåˆ¶ JSON è¾“å‡º
3. **æ ¼å¼è§£ææœºåˆ¶**ï¼šé€šè¿‡ `ResponseParser` å®ç° JSON æå–ã€éªŒè¯å’Œé”™è¯¯å¤„ç†
4. **å…³é”®å¸§è§†é¢‘å‘é€**ï¼šä½¿ç”¨ `GeminiService` ä¸Šä¼ è§†é¢‘å¹¶ç­‰å¾…å¤„ç†å®Œæˆ
5. **å†…å®¹è¯†åˆ«ä¸åˆ†æ**ï¼šå°†åˆ†æç»“æœä¿å­˜åˆ°æ•°æ®åº“ï¼Œæ”¯æŒ Key Findings å’Œ Timestamp Events

**æ¨èå®æ–½è·¯å¾„**ï¼š
1. å…ˆå®ç° `GeminiService`ã€`PromptBuilder`ã€`ResponseParser` ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶
2. åœ¨ [AnalyzerService](file:///d:/%E7%BC%96%E7%A8%8B/%E9%A1%B9%E7%9B%AE/AiVideoAnalsysSystem/python/services/analyzer_service.py#58-624) ä¸­é›†æˆ Gemini åˆ†æåŠŸèƒ½
3. æ‰©å±• `AnalyzerViewModel` æš´éœ²æ¥å£ç»™ QML
4. ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
5. éƒ¨ç½²å¹¶ç›‘æ§ API è°ƒç”¨æƒ…å†µ

é€šè¿‡æœ¬æ–¹æ¡ˆï¼Œç³»ç»Ÿå°†å…·å¤‡å¼ºå¤§çš„ AI è§†é¢‘å†…å®¹åˆ†æèƒ½åŠ›ï¼Œä¸ºç”¨æˆ·æä¾›æ™ºèƒ½åŒ–çš„è§†é¢‘ç†è§£æœåŠ¡ã€‚
